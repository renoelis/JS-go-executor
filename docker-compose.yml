# Flow-CodeBlock Goç‰ˆæœ¬ - æœ¬åœ°æµ‹è¯•ç¯å¢ƒ Docker Composeé…ç½®
# ç”¨äºæœ¬åœ°å¼€å‘å’Œæµ‹è¯•
version: '3.8'

services:
  # ====================================================================================
  # Go ä»£ç æ‰§è¡ŒæœåŠ¡ (æœ¬åœ°æµ‹è¯•ç¯å¢ƒ)
  # ====================================================================================
  flow-codeblock-go:
    build:
      context: .
      dockerfile: Dockerfile
    image: flow-codeblock-go:dev
    container_name: flow-codeblock-go-dev
    ports:
      - "3002:3002"
    
    environment:
      # ==================== åŸºç¡€é…ç½® ====================
      - ENVIRONMENT=development
      - PORT=3002
      - GIN_MODE=debug                   # å¼€å‘ç¯å¢ƒä½¿ç”¨debugæ¨¡å¼
      
      # ğŸ”¥ DoS é˜²æŠ¤é…ç½®
      - MAX_REQUEST_BODY_MB=10           # HTTP è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆMBï¼‰
      
      # ğŸ”’ CORS è·¨åŸŸé…ç½®
      - ALLOWED_ORIGINS=                 # ä¸ºç©ºåˆ™åªå…è®¸æœåŠ¡ç«¯å’ŒåŒåŸŸè°ƒç”¨
      
      # ==================== æ•°æ®åº“é…ç½® ====================
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=flow_user
      - DB_PASSWORD=flow_password_dev    # å¼€å‘ç¯å¢ƒå¯†ç 
      - DB_NAME=flow_codeblock_go
      - DB_MAX_OPEN_CONNS=50             # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘è¿æ¥æ•°
      - DB_MAX_IDLE_CONNS=10
      - DB_CONN_MAX_LIFETIME_MIN=30
      - DB_CONN_MAX_IDLE_TIME_MIN=5
      
      # ==================== Redisé…ç½® ====================
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=flow_redis_dev    # å¼€å‘ç¯å¢ƒå¯†ç 
      - REDIS_DB=0
      - REDIS_POOL_SIZE=50               # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘è¿æ¥æ•°
      - REDIS_MIN_IDLE_CONNS=5
      - REDIS_DIAL_TIMEOUT_SEC=5
      - REDIS_READ_TIMEOUT_SEC=3
      - REDIS_WRITE_TIMEOUT_SEC=3
      - REDIS_MAX_RETRIES=3
      
      # ==================== ğŸ” è®¤è¯é…ç½® ====================
      # å¼€å‘ç¯å¢ƒä½¿ç”¨ç®€å•Tokenï¼ˆ16å­—ç¬¦ï¼Œä¸åŒ…å«å¼±å¯†ç å…³é”®è¯ï¼‰
      - ADMIN_TOKEN=${ADMIN_TOKEN:-devABCDEFGHJKLMN}
      
      # ==================== Tokenç¼“å­˜é…ç½® ====================
      - TOKEN_CACHE_HOT_SIZE=200         # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘ç¼“å­˜
      - TOKEN_CACHE_HOT_TTL_MINUTES=3
      - TOKEN_CACHE_REDIS_TTL_MINUTES=30
      
      # ==================== ğŸ”¥ ç¼“å­˜å†™å…¥æ± é…ç½® ====================
      - CACHE_WRITE_POOL_WORKERS=5       # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘worker
      - CACHE_WRITE_POOL_QUEUE_SIZE=500  # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘é˜Ÿåˆ—
      - CACHE_WRITE_POOL_SUBMIT_TIMEOUT_MS=50
      
      # ==================== Tokené™æµé…ç½® ====================
      - RATE_LIMIT_HOT_SIZE=200          # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘ç¼“å­˜
      - RATE_LIMIT_REDIS_TTL_MINUTES=30
      - RATE_LIMIT_BATCH_SIZE=50
      
      # ==================== ğŸ”¥ é…é¢æ—¥å¿—æ¸…ç†é…ç½® ====================
      # è‡ªåŠ¨æ¸…ç†é…é¢æ¶ˆè€—æ—¥å¿—ï¼Œé¿å…æ•°æ®åº“è†¨èƒ€
      - QUOTA_CLEANUP_ENABLED=true       # æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ¸…ç†ï¼ˆé»˜è®¤ï¼štrueï¼‰
      - QUOTA_CLEANUP_RETENTION_DAYS=90  # ğŸ”§ å¼€å‘ç¯å¢ƒä¿ç•™90å¤©ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨è180å¤©ï¼‰
      - QUOTA_CLEANUP_INTERVAL_HOURS=24  # æ¸…ç†é—´éš”ï¼ˆå°æ—¶ï¼Œé»˜è®¤ï¼š24å°æ—¶ï¼‰
      - QUOTA_CLEANUP_BATCH_SIZE=10000   # æ¯æ‰¹åˆ é™¤æ•°é‡ï¼ˆé»˜è®¤ï¼š10000ï¼‰
      
      # ==================== ğŸ”¥ é…é¢åŒæ­¥é…ç½® ====================
      # åŠŸèƒ½ï¼šé…ç½®Redisåˆ°DBçš„é…é¢åŒæ­¥ç­–ç•¥
      # è¯´æ˜ï¼šé…é¢å‡†ç¡®æ€§ç”±RedisåŸå­æ“ä½œä¿è¯ï¼ŒåŒæ­¥é—´éš”åªå½±å“DBå®æ—¶æ€§
      - QUOTA_SYNC_QUEUE_SIZE=10000      # åŒæ­¥é˜Ÿåˆ—å®¹é‡ï¼ˆé»˜è®¤ï¼š10000ï¼‰
      - QUOTA_LOG_QUEUE_SIZE=10000       # æ—¥å¿—é˜Ÿåˆ—å®¹é‡ï¼ˆé»˜è®¤ï¼š10000ï¼‰
      - QUOTA_SYNC_BATCH_SIZE=500        # åŒæ­¥æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤ï¼š500ï¼‰
      - QUOTA_SYNC_INTERVAL_MS=1000      # åŒæ­¥é—´éš”ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ï¼š1000ï¼Œå³1ç§’ï¼‰
      
      # ==================== ğŸš¦ IPé™æµé…ç½® ====================
      # å¼€å‘ç¯å¢ƒä½¿ç”¨è¾ƒå®½æ¾çš„é™æµ
      - IP_RATE_LIMIT_PRE_AUTH=100       # å¼€å‘ç¯å¢ƒæ›´å®½æ¾
      - IP_RATE_LIMIT_PRE_AUTH_BURST=200
      - IP_RATE_LIMIT_POST_AUTH=500      # å¼€å‘ç¯å¢ƒæ›´å®½æ¾
      - IP_RATE_LIMIT_POST_AUTH_BURST=1000
      - IP_RATE_LIMIT_GLOBAL=100
      - IP_RATE_LIMIT_GLOBAL_BURST=200
      
      # ==================== ğŸš€ JavaScriptæ‰§è¡Œå™¨é…ç½® ====================
      # å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆé€‚åˆæœ¬åœ°æµ‹è¯•ï¼‰
      - RUNTIME_POOL_SIZE=20             # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘æ± å¤§å°
      - MIN_RUNTIME_POOL_SIZE=10
      - MAX_RUNTIME_POOL_SIZE=50
      - RUNTIME_IDLE_TIMEOUT_MIN=5
      - MAX_CONCURRENT_EXECUTIONS=200    # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘å¹¶å‘
      - CODE_CACHE_SIZE=50
      - ALLOW_CONSOLE=true               # ğŸ”§ å¼€å‘ç¯å¢ƒå…è®¸console
      
      # æ‰§è¡Œé™åˆ¶
      - MAX_CODE_LENGTH=65535            # 64KB
      - MAX_INPUT_SIZE=2097152           # 2MB
      - MAX_RESULT_SIZE=5242880          # 5MB
      - EXECUTION_TIMEOUT_MS=300000       # ğŸ”§ å¼€å‘ç¯å¢ƒ30ç§’è¶…æ—¶

      # ==================== ğŸ›¡ï¸ SSRF é˜²æŠ¤é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰====================
      # å¼€å‘ç¯å¢ƒé»˜è®¤ï¼šç¦ç”¨ SSRF é˜²æŠ¤ï¼ˆå…è®¸è®¿é—®å†…ç½‘æœåŠ¡ï¼‰
      # åŸå› ï¼šæœ¬åœ°å¼€å‘éœ€è¦è®¿é—®æ•°æ®åº“ã€å¾®æœåŠ¡ç­‰å†…ç½‘èµ„æº
      - ENABLE_SSRF_PROTECTION=${ENABLE_SSRF_PROTECTION:-false}   # å¼€å‘ç¯å¢ƒé»˜è®¤ç¦ç”¨
      - ALLOW_PRIVATE_IP=${ALLOW_PRIVATE_IP:-true}                # å¼€å‘ç¯å¢ƒé»˜è®¤å…è®¸ç§æœ‰IP

       # ==================== ğŸ”¥ å¹¶å‘æ§åˆ¶è¶…æ—¶é…ç½® ====================
      # è¯´æ˜ï¼šæ§åˆ¶ç³»ç»Ÿç¹å¿™æ—¶çš„ç­‰å¾…è¡Œä¸º
      - CONCURRENCY_WAIT_TIMEOUT_SEC=10  # å¹¶å‘æ§½ä½ç­‰å¾…è¶…æ—¶(ç§’) - é»˜è®¤ 10 ç§’
      - RUNTIME_POOL_ACQUIRE_TIMEOUT_SEC=5  # Runtime æ± è·å–è¶…æ—¶(ç§’) - é»˜è®¤ 5 ç§’
      
      # ==================== ğŸ” æ…¢æ‰§è¡Œæ£€æµ‹é…ç½® ====================
      # SLOW_EXECUTION_THRESHOLD_MS: æ…¢æ‰§è¡Œæ£€æµ‹é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
      # è¯´æ˜ï¼šè¶…è¿‡æ­¤æ—¶é—´çš„ä»£ç æ‰§è¡Œä¼šè®°å½• WARN æ—¥å¿—ï¼Œå¸®åŠ©å®šä½æ€§èƒ½é—®é¢˜
      - SLOW_EXECUTION_THRESHOLD_MS=3000  # é…ç½®ä¸º 3 ç§’ï¼Œ
      
      # ==================== ğŸ”¥ ç†”æ–­å™¨é…ç½® ====================
      - CIRCUIT_BREAKER_ENABLED=true
      - CIRCUIT_BREAKER_MIN_REQUESTS=50  # ğŸ”§ å¼€å‘ç¯å¢ƒé™ä½é˜ˆå€¼
      - CIRCUIT_BREAKER_FAILURE_RATIO=0.9
      - CIRCUIT_BREAKER_TIMEOUT_SEC=10
      - CIRCUIT_BREAKER_MAX_REQUESTS=50
      
      # ==================== Fetch API è¶…æ—¶é…ç½® ====================
      # ğŸ”¥ æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹å‚æ•°ï¼ˆv2.5.3 æ–°å¢ï¼‰
      - FETCH_TIMEOUT_MS=30000                      # HTTP è¯·æ±‚è¶…æ—¶ï¼ˆè¿æ¥+å‘é€+å“åº”å¤´ï¼Œ30ç§’ï¼‰
      - FETCH_RESPONSE_READ_TIMEOUT_MS=600000       # ğŸ”¥ å“åº”è¯»å–æ€»æ—¶é•¿è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼Œå¼€å‘ç¯å¢ƒå®½æ¾ï¼‰
      
      # ğŸ”¥ ä¸‹è½½é™åˆ¶ï¼ˆæ–°æ–¹æ¡ˆï¼‰
      - MAX_RESPONSE_SIZE_MB=5           # ç¼“å†²è¯»å–é™åˆ¶(arrayBuffer/blob/text/json) - é»˜è®¤1MB
      - MAX_STREAMING_SIZE_MB=1        # æµå¼è¯»å–é™åˆ¶(getReader) - é»˜è®¤100MB
      
      # ğŸ”¥ ä¸Šä¼ é™åˆ¶ï¼ˆæ–°æ–¹æ¡ˆï¼‰
      - MAX_BUFFERED_FORMDATA_MB=5       # ç¼“å†²ä¸Šä¼ é™åˆ¶(Web FormData + Blobã€Node.js form-data + Buffer) - é»˜è®¤1MB
      - MAX_STREAMING_FORMDATA_MB=5    # æµå¼ä¸Šä¼ é™åˆ¶(Node.js form-data + Stream) - é»˜è®¤100MB
      
      # å…¶ä»–é…ç½®
      - ENABLE_CHUNKED_UPLOAD=1          # å¯ç”¨åˆ†å—ä¼ è¾“ç¼–ç 
      - MAX_BLOB_FILE_SIZE_MB=1          # Blob/Fileæœ€å¤§å¤§å°(MB)
      - FORMDATA_BUFFER_SIZE=524288      # FormDataç¼“å†²åŒºå¤§å°(å­—èŠ‚) - 512KB
      - MAX_FILE_SIZE_MB=1               # å•æ–‡ä»¶æœ€å¤§å¤§å°(MB)
      
      # ğŸ”¥ XLSX æ¨¡å—é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
      - XLSX_MAX_SNAPSHOT_SIZE_MB=5      # Copy-on-Read æ¨¡å¼çš„æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆé»˜è®¤5MBï¼Œå¼€å‘ç¯å¢ƒå¯é€‚å½“è°ƒæ•´ï¼‰
      - XLSX_MAX_ROWS=50000              # ğŸ”¥ æœ€å¤§è¡Œæ•°é™åˆ¶ï¼ˆé»˜è®¤100000ï¼Œå¼€å‘ç¯å¢ƒè®¾ä¸º50000ï¼‰
      - XLSX_MAX_COLS=100                # ğŸ”¥ æœ€å¤§åˆ—æ•°é™åˆ¶ï¼ˆé»˜è®¤100ï¼‰
      
      # ğŸ”¥ HTTP Transport é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼šè¾ƒå°å€¼ï¼Œä¾¿äºè°ƒè¯•ï¼‰
      - HTTP_MAX_IDLE_CONNS=30                   # å…¨å±€æœ€å¤§ç©ºé—²è¿æ¥æ•°
      - HTTP_MAX_IDLE_CONNS_PER_HOST=5           # æ¯ä¸ª host çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°
      - HTTP_MAX_CONNS_PER_HOST=50               # æ¯ä¸ª host çš„æœ€å¤§è¿æ¥æ•°
      - HTTP_IDLE_CONN_TIMEOUT_SEC=60            # ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
      - HTTP_DIAL_TIMEOUT_SEC=10                 # è¿æ¥å»ºç«‹è¶…æ—¶ï¼ˆç§’ï¼‰
      - HTTP_KEEP_ALIVE_SEC=30                   # Keep-Alive é—´éš”ï¼ˆç§’ï¼‰
      - HTTP_TLS_HANDSHAKE_TIMEOUT_SEC=10        # TLS æ¡æ‰‹è¶…æ—¶ï¼ˆç§’ï¼‰
      - HTTP_EXPECT_CONTINUE_TIMEOUT_SEC=1       # æœŸæœ›ç»§ç»­è¶…æ—¶ï¼ˆç§’ï¼‰
      - HTTP_FORCE_HTTP2=true                    # å¯ç”¨ HTTP/2
      - HTTP_RESPONSE_BODY_IDLE_TIMEOUT_MIN=5    # ğŸ”¥ å“åº”ä½“ç©ºé—²è¶…æ—¶ï¼ˆåˆ†é’Ÿï¼Œé˜²æ­¢èµ„æºæ³„æ¼ï¼‰
      
      # ==================== JavaScript å†…å­˜é™åˆ¶ ====================
      # è¯´æ˜ï¼šæ‹¦æˆª JavaScript ä¾§çš„å¤§å†…å­˜åˆ†é…ï¼ˆArrayã€TypedArrayã€ArrayBufferã€Array.pushï¼‰
      # 
      # ENABLE_JS_MEMORY_LIMIT: æ˜¯å¦å¯ç”¨ JS ä¾§å†…å­˜é™åˆ¶
      #   - true: å¯ç”¨ï¼ˆé»˜è®¤ï¼‰
      #   - false: ç¦ç”¨ï¼ˆå…è®¸æ— é™åˆ¶åˆ›å»ºæ•°ç»„ï¼Œâš ï¸ å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºï¼‰
      # 
      # JS_MEMORY_LIMIT_MB: JavaScript å•æ¬¡åˆ†é…çš„æœ€å¤§å†…å­˜å¤§å°ï¼ˆMBï¼‰
      #   - 0: ä½¿ç”¨ MAX_BLOB_FILE_SIZE_MB çš„å€¼ï¼ˆé»˜è®¤ï¼Œè‡ªåŠ¨è·Ÿéšï¼‰
      #   - >0: æŒ‡å®šå…·ä½“é™åˆ¶ï¼ˆå¦‚ 10 = 10MBï¼‰
      #   
      # ğŸ” Array.push é™åˆ¶è®¡ç®—ï¼š
      #   æœ€å¤§å…ƒç´ æ•° = (JS_MEMORY_LIMIT_MB * 1024 * 1024) / 8
      #   ç¤ºä¾‹ï¼š
      #     - 1MB  â†’ 131,072 ä¸ªå…ƒç´ ï¼ˆå¼€å‘ç¯å¢ƒå½“å‰å€¼ï¼‰
      #     - 10MB â†’ 1,310,720 ä¸ªå…ƒç´ 
      #     - 12MB â†’ 1,572,864 ä¸ªå…ƒç´ ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
      # 
      # âš ï¸ æ³¨æ„ï¼š
      #   - Array.push è¶…é™æ—¶ä¼šæŠ›å‡ºä¸­æ–‡é”™è¯¯ï¼š"Array.push æ“ä½œä¼šå¯¼è‡´æ•°ç»„é•¿åº¦è¶…è¿‡é™åˆ¶..."
      #   - å…¶ä»–é™åˆ¶åŒ…æ‹¬ï¼šnew Array(n)ã€new Uint8Array(n)ã€new ArrayBuffer(n)
      - ENABLE_JS_MEMORY_LIMIT=true      # ğŸ”§ å¯ç”¨ JS ä¾§å†…å­˜é™åˆ¶ï¼ˆé»˜è®¤ï¼štrueï¼‰
      - JS_MEMORY_LIMIT_MB=0              # ğŸ”§ é™åˆ¶å¤§å°ï¼ˆ0=ä½¿ç”¨ MAX_BLOB_FILE_SIZE_MBï¼Œå½“å‰ä¸º1MB â†’ 131Kå…ƒç´ ï¼‰
      
      # ==================== ğŸ”¥ å¥åº·æ£€æŸ¥å’Œæ± ç®¡ç†é…ç½® ====================
      # å¼€å‘ç¯å¢ƒï¼šè¾ƒå®½æ¾çš„é˜ˆå€¼ï¼Œä¾¿äºè°ƒè¯•
      - MIN_ERROR_COUNT_FOR_CHECK=5              # æœ€å°é”™è¯¯æ¬¡æ•°é˜ˆå€¼ï¼ˆå¼€å‘ç¯å¢ƒï¼š5ï¼Œä¾¿äºå¿«é€Ÿå‘ç°é—®é¢˜ï¼‰
      - MAX_ERROR_RATE_THRESHOLD=0.15            # æœ€å¤§é”™è¯¯ç‡é˜ˆå€¼ï¼ˆå¼€å‘ç¯å¢ƒï¼š0.15 å³ 15%ï¼Œå®¹å¿è°ƒè¯•é”™è¯¯ï¼‰
      - MIN_EXECUTION_COUNT_FOR_STATS=500        # ç»Ÿè®¡é•¿æœŸè¿è¡Œçš„æœ€å°æ‰§è¡Œæ¬¡æ•°ï¼ˆå¼€å‘ç¯å¢ƒï¼š500ï¼Œå¿«é€Ÿè¿›å…¥ç»Ÿè®¡ï¼‰
      - LONG_RUNNING_THRESHOLD_MINUTES=30        # é•¿æœŸè¿è¡Œæ—¶é—´é˜ˆå€¼ï¼ˆå¼€å‘ç¯å¢ƒï¼š30åˆ†é’Ÿï¼‰
      - POOL_EXPANSION_THRESHOLD_PERCENT=0.2     # æ± æ‰©å±•é˜ˆå€¼ï¼ˆå¼€å‘ç¯å¢ƒï¼š0.2 å³ 20%ï¼Œé¿å…é¢‘ç¹æ‰©å±•ï¼‰
      - HEALTH_CHECK_INTERVAL_SECONDS=60         # å¥åº·æ£€æŸ¥é—´éš”ï¼ˆå¼€å‘ç¯å¢ƒï¼š60ç§’ï¼Œå‡å°‘æ—¥å¿—è¾“å‡ºï¼‰
      
      # ==================== Goè¿è¡Œæ—¶é…ç½® ====================
      - GOMAXPROCS=0                     # ä½¿ç”¨æ‰€æœ‰CPU
      - GOGC=100
      - GOMEMLIMIT=2048MiB
      
      # ==================== ğŸ” è°ƒè¯•é…ç½® ====================
      - ENABLE_PPROF=true                # å¼€å‘ç¯å¢ƒå¯ç”¨ pprof æ¥å£
      
      # ==================== ğŸ”§ æµ‹è¯•å·¥å…·é…ç½® ====================
      # æµ‹è¯•å·¥å…·é¡µé¢é…ç½® - è®¿é—®åœ°å€: http://localhost:3002/flow/test-tool
      # å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°åœ°å€
      - TEST_TOOL_API_URL=http://localhost:3002 
      - TEST_TOOL_LOGO_URL=https://qingflow.com/                                          # APIæœåŠ¡åœ°å€
      - TEST_TOOL_HELP_URL=https://exiao.yuque.com/rlf3k1/oanb79/fa3tqkxk1h2n912q         # Flow CodeBlock å¸®åŠ©æ–‡æ¡£
      - TEST_TOOL_API_DOC_URL=https://exiao.yuque.com/rlf3k1/oanb79/ybd2nfdshmhaihc2      # Flow CodeBlock API æ¥å£æ–‡æ¡£
      - TEST_TOOL_GUIDE_URL=https://exiao.yuque.com/rlf3k1/oanb79/olsa9bvc6vm2m26c        # Flow CodeBlock åœ¨çº¿æµ‹è¯•å·¥å…·ä½¿ç”¨æŒ‡å—
      - TEST_TOOL_EXAMPLE_URL=https://exiao.yuque.com/rlf3k1/oanb79/tlty7ic7szfr2v7v     # Flow CodeBlock ä»£ç ç¤ºä¾‹
      - TEST_TOOL_AI_URL=https://wings.qingflow.com/ultron/share/agent/443790716135587842 # è½»ç¿¼AIï¼šFlow CodeBlock ä»£ç AIåŠ©æ‰‹
      - TEST_TOOL_APPLY_URL=https://qingflow.com/f/cabirpa60001                          # ç”³è¯·å¼€é€šæœåŠ¡é“¾æ¥
      
      # ==================== ğŸ¨ è‡ªå®šä¹‰Logoé…ç½® ====================
      # ä¼˜å…ˆçº§ï¼šCUSTOM_LOGO_URLï¼ˆæœ€é«˜ï¼‰> CUSTOM_LOGO_PATH > é»˜è®¤Logo
      - CUSTOM_LOGO_URL=${CUSTOM_LOGO_URL:-}              # ğŸ¨ è‡ªå®šä¹‰Logoå¤–éƒ¨URLï¼ˆå¦‚CDNé“¾æ¥ï¼‰
      - CUSTOM_LOGO_PATH=${CUSTOM_LOGO_PATH:-}            # ğŸ¨ è‡ªå®šä¹‰Logoæœ¬åœ°è·¯å¾„ï¼ˆå®¹å™¨å†…è·¯å¾„ï¼Œå¦‚ï¼š/app/logos/your-logo.pngï¼‰
    
    restart: "no"  # å¼€å‘ç¯å¢ƒä¸è‡ªåŠ¨é‡å¯ï¼Œæ–¹ä¾¿è°ƒè¯•
    
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    # ==================== ğŸ”§ èµ„æºé™åˆ¶ ====================
    # å¼€å‘ç¯å¢ƒè¾ƒå®½æ¾çš„é™åˆ¶
    deploy:
      resources:
        limits:
          memory: 2.5G          # ğŸ”§ 2GBè¶³å¤Ÿå¼€å‘æµ‹è¯•
          cpus: '4.0'         # ğŸ”§ 4æ ¸CPU
        reservations:
          memory: 512M
          cpus: '1.0'
    
    # ==================== å®‰å…¨é…ç½® ====================
    # å¼€å‘ç¯å¢ƒä¸å¯ç”¨ä¸¥æ ¼çš„å®‰å…¨é™åˆ¶
    security_opt:
      - no-new-privileges:true
    # read_only: false      # å¼€å‘ç¯å¢ƒå…è®¸å†™å…¥
    tmpfs:
      - /tmp:size=200m      # å¼€å‘ç¯å¢ƒæ›´å¤§çš„ä¸´æ—¶ç©ºé—´
    
    # ==================== å¥åº·æ£€æŸ¥ ====================
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 15s         # å¼€å‘ç¯å¢ƒæ›´é¢‘ç¹æ£€æŸ¥
      timeout: 5s
      retries: 2
      start_period: 5s
    
    # ==================== ç½‘ç»œé…ç½® ====================
    networks:
      - flow-dev-network
    
    # ==================== æ—¥å¿—é…ç½® ====================
    logging:
      driver: "json-file"
      options:
        max-size: "10m"     # å¼€å‘ç¯å¢ƒè¾ƒå°çš„æ—¥å¿—æ–‡ä»¶
        max-file: "2"
    
    # ==================== å·æŒ‚è½½ ====================
    volumes:
      - /etc/localtime:/etc/localtime:ro
      # ğŸ’¡ å¯é€‰ï¼šæŒ‚è½½æºç ç›®å½•ä»¥æ”¯æŒçƒ­é‡è½½ï¼ˆéœ€è¦é…åˆairç­‰å·¥å…·ï¼‰
      # - ./:/app:ro
      
      # ğŸ¨ è‡ªå®šä¹‰Logoå·æŒ‚è½½ï¼ˆå¦‚æœä½¿ç”¨ CUSTOM_LOGO_PATHï¼‰
      # å–æ¶ˆæ³¨é‡Šä¸‹é¢ä¸€è¡Œï¼Œå°†å®¿ä¸»æœºçš„ logos ç›®å½•æŒ‚è½½åˆ°å®¹å™¨
      #- ./logos:/app/logos:ro
      # ç„¶åè®¾ç½®ç¯å¢ƒå˜é‡: CUSTOM_LOGO_PATH=/app/logos/your-logo.png
    
    # ==================== æ ‡ç­¾ ====================
    labels:
      - "com.flow-codeblock.service=go-executor"
      - "com.flow-codeblock.version=2.1"
      - "com.flow-codeblock.environment=development"
      - "com.flow-codeblock.description=æœ¬åœ°æµ‹è¯•ç¯å¢ƒ"

  # ====================================================================================
  # MySQLæ•°æ®åº“æœåŠ¡ (å¼€å‘ç¯å¢ƒ)
  # ====================================================================================
  mysql:
    image: mysql:8.0
    container_name: flow-mysql-dev
    environment:
      - MYSQL_ROOT_PASSWORD=root_dev_password
      - MYSQL_DATABASE=flow_codeblock_go
      - MYSQL_USER=flow_user
      - MYSQL_PASSWORD=flow_password_dev
      - MYSQL_CHARSET=utf8mb4
      - MYSQL_COLLATION=utf8mb4_unicode_ci
    restart: "no"
    
    # å¥åº·æ£€æŸ¥
    # è¯´æ˜ï¼šä¸ä»…æ£€æŸ¥MySQLæœåŠ¡ï¼Œè¿˜è¦ç¡®ä¿æ•°æ®åº“å’Œè¡¨å·²åˆ›å»ºï¼ˆinit.sqlæ‰§è¡Œå®Œæˆï¼‰
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u flow_user -pflow_password_dev && mysql -u flow_user -pflow_password_dev flow_codeblock_go -e 'SELECT 1 FROM access_tokens LIMIT 1' > /dev/null 2>&1 || exit 1"]
      timeout: 10s
      retries: 10
      interval: 5s
      start_period: 40s  # å¢åŠ å¯åŠ¨ç­‰å¾…æ—¶é—´ï¼Œç¡®ä¿init.sqlæ‰§è¡Œå®Œæˆ
    
    # èµ„æºé™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    deploy:
      resources:
        limits:
          memory: 1G        # ğŸ”§ å¼€å‘ç¯å¢ƒ1GB
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # ç½‘ç»œé…ç½®
    networks:
      - flow-dev-network
    
    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - mysql_dev_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=database"
      - "com.flow-codeblock.environment=development"

  # ====================================================================================
  # Redisç¼“å­˜æœåŠ¡ (å¼€å‘ç¯å¢ƒ)
  # ====================================================================================
  redis:
    image: redis:7-alpine
    container_name: flow-redis-dev
    # ğŸ”¥ è‡ªåŠ¨å¯ç”¨AOFæŒä¹…åŒ–ï¼ˆé…é¢ç³»ç»Ÿéœ€è¦ï¼‰
    command: redis-server --requirepass flow_redis_dev --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes --appendfsync everysec
    restart: "no"
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "flow_redis_dev", "ping"]
      timeout: 3s
      retries: 3
      interval: 10s
      start_period: 5s
    
    # èµ„æºé™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    deploy:
      resources:
        limits:
          memory: 512M      # ğŸ”§ å¼€å‘ç¯å¢ƒ512MB
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    # ç½‘ç»œé…ç½®
    networks:
      - flow-dev-network
    
    # æ•°æ®æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼Œå¼€å‘ç¯å¢ƒå¯ä»¥ä¸æŒä¹…åŒ–ï¼‰
    volumes:
      # - redis_dev_data:/data    # å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨æ•°æ®æŒä¹…åŒ–
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=cache"
      - "com.flow-codeblock.environment=development"

# ====================================================================================
# ç½‘ç»œé…ç½®
# ====================================================================================
networks:
  flow-dev-network:
    driver: bridge
    name: flow-dev-network

# ====================================================================================
# æ•°æ®å·
# ====================================================================================
volumes:
  mysql_dev_data:
    driver: local
  # redis_dev_data:
  #   driver: local
