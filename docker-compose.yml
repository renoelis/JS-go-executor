# Flow-CodeBlock Goç‰ˆæœ¬ - æœ¬åœ°æµ‹è¯•ç¯å¢ƒ Docker Composeé…ç½®
# ç”¨äºæœ¬åœ°å¼€å‘å’Œæµ‹è¯•
version: '3.8'

services:
  # ====================================================================================
  # Go ä»£ç æ‰§è¡ŒæœåŠ¡ (æœ¬åœ°æµ‹è¯•ç¯å¢ƒ)
  # ====================================================================================
  flow-codeblock-go:
    build:
      context: .
      dockerfile: Dockerfile
    image: flow-codeblock-go:dev
    container_name: flow-codeblock-go-dev
    ports:
      - "3002:3002"
    
    environment:
      # ==================== åŸºç¡€é…ç½® ====================
      - ENVIRONMENT=development
      - PORT=3002
      - GIN_MODE=debug                   # å¼€å‘ç¯å¢ƒä½¿ç”¨debugæ¨¡å¼
      
      # ==================== æ•°æ®åº“é…ç½® ====================
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=flow_user
      - DB_PASSWORD=flow_password_dev    # å¼€å‘ç¯å¢ƒå¯†ç 
      - DB_NAME=flow_codeblock_go
      - DB_MAX_OPEN_CONNS=50             # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘è¿æ¥æ•°
      - DB_MAX_IDLE_CONNS=10
      - DB_CONN_MAX_LIFETIME_MIN=30
      - DB_CONN_MAX_IDLE_TIME_MIN=5
      
      # ==================== Redisé…ç½® ====================
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=flow_redis_dev    # å¼€å‘ç¯å¢ƒå¯†ç 
      - REDIS_DB=0
      - REDIS_POOL_SIZE=50               # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘è¿æ¥æ•°
      - REDIS_MIN_IDLE_CONNS=5
      - REDIS_DIAL_TIMEOUT_SEC=5
      - REDIS_READ_TIMEOUT_SEC=3
      - REDIS_WRITE_TIMEOUT_SEC=3
      - REDIS_MAX_RETRIES=3
      
      # ==================== ğŸ” è®¤è¯é…ç½® ====================
      # å¼€å‘ç¯å¢ƒä½¿ç”¨ç®€å•Tokenï¼ˆ16å­—ç¬¦ï¼Œä¸åŒ…å«å¼±å¯†ç å…³é”®è¯ï¼‰
      - ADMIN_TOKEN=${ADMIN_TOKEN:-devABCDEFGHJKLMN}
      
      # ==================== Tokenç¼“å­˜é…ç½® ====================
      - TOKEN_CACHE_HOT_SIZE=200         # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘ç¼“å­˜
      - TOKEN_CACHE_HOT_TTL_MINUTES=3
      - TOKEN_CACHE_REDIS_TTL_MINUTES=30
      
      # ==================== ğŸ”¥ ç¼“å­˜å†™å…¥æ± é…ç½® ====================
      - CACHE_WRITE_POOL_WORKERS=5       # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘worker
      - CACHE_WRITE_POOL_QUEUE_SIZE=500  # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘é˜Ÿåˆ—
      - CACHE_WRITE_POOL_SUBMIT_TIMEOUT_MS=50
      
      # ==================== Tokené™æµé…ç½® ====================
      - RATE_LIMIT_HOT_SIZE=200          # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘ç¼“å­˜
      - RATE_LIMIT_REDIS_TTL_MINUTES=30
      - RATE_LIMIT_BATCH_SIZE=50
      
      # ==================== ğŸš¦ IPé™æµé…ç½® ====================
      # å¼€å‘ç¯å¢ƒä½¿ç”¨è¾ƒå®½æ¾çš„é™æµ
      - IP_RATE_LIMIT_PRE_AUTH=100       # å¼€å‘ç¯å¢ƒæ›´å®½æ¾
      - IP_RATE_LIMIT_PRE_AUTH_BURST=200
      - IP_RATE_LIMIT_POST_AUTH=500      # å¼€å‘ç¯å¢ƒæ›´å®½æ¾
      - IP_RATE_LIMIT_POST_AUTH_BURST=1000
      - IP_RATE_LIMIT_GLOBAL=100
      - IP_RATE_LIMIT_GLOBAL_BURST=200
      
      # ==================== ğŸš€ JavaScriptæ‰§è¡Œå™¨é…ç½® ====================
      # å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆé€‚åˆæœ¬åœ°æµ‹è¯•ï¼‰
      - RUNTIME_POOL_SIZE=20             # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘æ± å¤§å°
      - MIN_RUNTIME_POOL_SIZE=10
      - MAX_RUNTIME_POOL_SIZE=50
      - RUNTIME_IDLE_TIMEOUT_MIN=5
      - MAX_CONCURRENT_EXECUTIONS=200    # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘å¹¶å‘
      - CODE_CACHE_SIZE=50
      - ALLOW_CONSOLE=true               # ğŸ”§ å¼€å‘ç¯å¢ƒå…è®¸console
      
      # æ‰§è¡Œé™åˆ¶
      - MAX_CODE_LENGTH=65535            # 64KB
      - MAX_INPUT_SIZE=2097152           # 2MB
      - MAX_RESULT_SIZE=5242880          # 5MB
      - EXECUTION_TIMEOUT_MS=30000       # ğŸ”§ å¼€å‘ç¯å¢ƒ30ç§’è¶…æ—¶
      
      # ==================== ğŸ”¥ ç†”æ–­å™¨é…ç½® ====================
      - CIRCUIT_BREAKER_ENABLED=true
      - CIRCUIT_BREAKER_MIN_REQUESTS=50  # ğŸ”§ å¼€å‘ç¯å¢ƒé™ä½é˜ˆå€¼
      - CIRCUIT_BREAKER_FAILURE_RATIO=0.9
      - CIRCUIT_BREAKER_TIMEOUT_SEC=10
      - CIRCUIT_BREAKER_MAX_REQUESTS=50
      
      # ==================== Fetch APIé…ç½® ====================
      - FETCH_TIMEOUT_MS=30000           # 30ç§’
      - MAX_FORMDATA_SIZE_MB=50          # ğŸ”§ å¼€å‘ç¯å¢ƒå‡å°‘é™åˆ¶
      - FORMDATA_STREAMING_THRESHOLD_MB=1
      - ENABLE_CHUNKED_UPLOAD=1
      - MAX_BLOB_FILE_SIZE_MB=50
      - FORMDATA_BUFFER_SIZE=1048576     # 1MB
      - MAX_FILE_SIZE_MB=25
      
      # ==================== Goè¿è¡Œæ—¶é…ç½® ====================
      - GOMAXPROCS=0                     # ä½¿ç”¨æ‰€æœ‰CPU
      - GOGC=100
      
      # ==================== ğŸ”§ æµ‹è¯•å·¥å…·é…ç½® ====================
      # æµ‹è¯•å·¥å…·é¡µé¢é…ç½® - è®¿é—®åœ°å€: http://localhost:3002/flow/test-tool
      # å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°åœ°å€
      - TEST_TOOL_API_URL=http://localhost:3002                                      # APIæœåŠ¡åœ°å€
      - TEST_TOOL_AI_URL=https://qingflow.com/pc-ultron/share/agent/289302286342078465  # è½»ç¿¼AIåŠ©æ‰‹é“¾æ¥
      - TEST_TOOL_HELP_URL=https://exiao.yuque.com/ixwxsb/cqfg2y/or5052bo2dtukro2  # å¸®åŠ©æ–‡æ¡£é“¾æ¥
      - TEST_TOOL_EXAMPLE_URL=https://exiao.yuque.com/rlf3k1/oanb79/tlty7ic7szfr2v7v?singleDoc#  # ä»£ç å—ç¤ºä¾‹é“¾æ¥
      - TEST_TOOL_APPLY_URL=https://qingflow.com/f/9cah24om6402                    # ç”³è¯·å¼€é€šæœåŠ¡é“¾æ¥
    
    restart: "no"  # å¼€å‘ç¯å¢ƒä¸è‡ªåŠ¨é‡å¯ï¼Œæ–¹ä¾¿è°ƒè¯•
    
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    # ==================== ğŸ”§ èµ„æºé™åˆ¶ ====================
    # å¼€å‘ç¯å¢ƒè¾ƒå®½æ¾çš„é™åˆ¶
    deploy:
      resources:
        limits:
          memory: 2G          # ğŸ”§ 2GBè¶³å¤Ÿå¼€å‘æµ‹è¯•
          cpus: '4.0'         # ğŸ”§ 4æ ¸CPU
        reservations:
          memory: 512M
          cpus: '1.0'
    
    # ==================== å®‰å…¨é…ç½® ====================
    # å¼€å‘ç¯å¢ƒä¸å¯ç”¨ä¸¥æ ¼çš„å®‰å…¨é™åˆ¶
    security_opt:
      - no-new-privileges:true
    # read_only: false      # å¼€å‘ç¯å¢ƒå…è®¸å†™å…¥
    tmpfs:
      - /tmp:size=200m      # å¼€å‘ç¯å¢ƒæ›´å¤§çš„ä¸´æ—¶ç©ºé—´
    
    # ==================== å¥åº·æ£€æŸ¥ ====================
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 15s         # å¼€å‘ç¯å¢ƒæ›´é¢‘ç¹æ£€æŸ¥
      timeout: 5s
      retries: 2
      start_period: 5s
    
    # ==================== ç½‘ç»œé…ç½® ====================
    networks:
      - flow-dev-network
    
    # ==================== æ—¥å¿—é…ç½® ====================
    logging:
      driver: "json-file"
      options:
        max-size: "10m"     # å¼€å‘ç¯å¢ƒè¾ƒå°çš„æ—¥å¿—æ–‡ä»¶
        max-file: "2"
    
    # ==================== å·æŒ‚è½½ ====================
    volumes:
      - /etc/localtime:/etc/localtime:ro
      # ğŸ’¡ å¯é€‰ï¼šæŒ‚è½½æºç ç›®å½•ä»¥æ”¯æŒçƒ­é‡è½½ï¼ˆéœ€è¦é…åˆairç­‰å·¥å…·ï¼‰
      # - ./:/app:ro
    
    # ==================== æ ‡ç­¾ ====================
    labels:
      - "com.flow-codeblock.service=go-executor"
      - "com.flow-codeblock.version=2.1"
      - "com.flow-codeblock.environment=development"
      - "com.flow-codeblock.description=æœ¬åœ°æµ‹è¯•ç¯å¢ƒ"

  # ====================================================================================
  # MySQLæ•°æ®åº“æœåŠ¡ (å¼€å‘ç¯å¢ƒ)
  # ====================================================================================
  mysql:
    image: mysql:8.0
    container_name: flow-mysql-dev
    environment:
      - MYSQL_ROOT_PASSWORD=root_dev_password
      - MYSQL_DATABASE=flow_codeblock_go
      - MYSQL_USER=flow_user
      - MYSQL_PASSWORD=flow_password_dev
      - MYSQL_CHARSET=utf8mb4
      - MYSQL_COLLATION=utf8mb4_unicode_ci
    restart: "no"
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "flow_user", "-pflow_password_dev"]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 20s
    
    # èµ„æºé™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    deploy:
      resources:
        limits:
          memory: 1G        # ğŸ”§ å¼€å‘ç¯å¢ƒ1GB
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # ç½‘ç»œé…ç½®
    networks:
      - flow-dev-network
    
    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - mysql_dev_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=database"
      - "com.flow-codeblock.environment=development"

  # ====================================================================================
  # Redisç¼“å­˜æœåŠ¡ (å¼€å‘ç¯å¢ƒ)
  # ====================================================================================
  redis:
    image: redis:7-alpine
    container_name: flow-redis-dev
    command: redis-server --requirepass flow_redis_dev --maxmemory 512mb --maxmemory-policy allkeys-lru
    restart: "no"
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "flow_redis_dev", "ping"]
      timeout: 3s
      retries: 3
      interval: 10s
      start_period: 5s
    
    # èµ„æºé™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    deploy:
      resources:
        limits:
          memory: 512M      # ğŸ”§ å¼€å‘ç¯å¢ƒ512MB
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    # ç½‘ç»œé…ç½®
    networks:
      - flow-dev-network
    
    # æ•°æ®æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼Œå¼€å‘ç¯å¢ƒå¯ä»¥ä¸æŒä¹…åŒ–ï¼‰
    volumes:
      # - redis_dev_data:/data    # å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨æ•°æ®æŒä¹…åŒ–
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=cache"
      - "com.flow-codeblock.environment=development"

# ====================================================================================
# ç½‘ç»œé…ç½®
# ====================================================================================
networks:
  flow-dev-network:
    driver: bridge
    name: flow-dev-network

# ====================================================================================
# æ•°æ®å·
# ====================================================================================
volumes:
  mysql_dev_data:
    driver: local
  # redis_dev_data:
  #   driver: local
