# 配额同步配置说明

## 📋 环境变量配置

### 配置项列表

| 环境变量 | 默认值 | 说明 | 推荐值 |
|---------|--------|------|--------|
| `QUOTA_SYNC_QUEUE_SIZE` | 10000 | 同步队列容量 | 10000 |
| `QUOTA_LOG_QUEUE_SIZE` | 10000 | 日志队列容量 | 10000 |
| `QUOTA_SYNC_BATCH_SIZE` | 500 | 同步批次大小 | 500 |
| `QUOTA_SYNC_INTERVAL_MS` | 1000 | 同步间隔（毫秒） | 1000 |

---

## 🎯 配置说明

### 1. QUOTA_SYNC_QUEUE_SIZE（同步队列容量）

**作用**：配额同步任务的队列容量

**影响**：
- 队列满时，新的同步任务会被丢弃（但不影响配额扣减）
- 容量越大，能缓冲的同步任务越多

**推荐配置**：

| 应用类型 | QPS | 推荐值 | 说明 |
|---------|-----|--------|------|
| 低流量 | < 10 | 5000 | 足够缓冲 |
| 中等流量 | 10-100 | 10000 | **推荐** |
| 高流量 | > 100 | 20000-50000 | 需要更大缓冲 |

**计算公式**：
```
队列容量 ≥ QPS × 同步间隔(秒) × 2
例如：QPS=100, 间隔=1秒
队列容量 ≥ 100 × 1 × 2 = 200（实际建议10000）
```

---

### 2. QUOTA_LOG_QUEUE_SIZE（日志队列容量）

**作用**：审计日志的队列容量

**影响**：
- 队列满时，新的日志会被丢弃
- 容量越大，能缓冲的日志越多

**推荐配置**：

| 应用类型 | 推荐值 | 说明 |
|---------|--------|------|
| 低流量 | 5000 | 与同步队列相同 |
| 中等流量 | 10000 | **推荐** |
| 高流量 | 20000-50000 | 与同步队列相同 |

**注意**：通常设置为与`QUOTA_SYNC_QUEUE_SIZE`相同

---

### 3. QUOTA_SYNC_BATCH_SIZE（同步批次大小）

**作用**：每次批量写入DB的记录数

**影响**：
- 批次越大，DB写入次数越少，但单次写入时间越长
- 批次越小，DB写入次数越多，但单次写入更快

**推荐配置**：

| 数据库性能 | 推荐值 | 说明 |
|-----------|--------|------|
| 低性能 | 100-200 | 小批次，减少单次压力 |
| 中等性能 | 500 | **推荐** |
| 高性能 | 1000-2000 | 大批次，减少写入次数 |

**性能对比**：

| 批次大小 | 每分钟写入次数 | 单次耗时 | 推荐 |
|---------|--------------|---------|------|
| 100 | 600次 | 5-10ms | 低性能DB |
| 500 | 120次 | 20-50ms | ✅ 推荐 |
| 1000 | 60次 | 50-100ms | 高性能DB |

---

### 4. QUOTA_SYNC_INTERVAL_MS（同步间隔）

**作用**：Redis到DB的同步间隔（毫秒）

**影响**：
- 间隔越短，DB数据越实时，但写入频率越高
- 间隔越长，DB数据延迟越大，但写入频率越低

**推荐配置**：

| 应用类型 | 推荐值 | 说明 |
|---------|--------|------|
| 低流量 | 5000 (5秒) | 降低DB压力 |
| 中等流量 | 1000 (1秒) | **推荐** |
| 高流量 | 500 (0.5秒) | 提高实时性 |

**性能影响**：

| 间隔 | 每分钟同步 | DB延迟 | Redis故障风险 |
|------|-----------|--------|--------------|
| 5秒 | 12次 | 最多5秒 | 5秒数据 |
| 1秒 | 60次 | 最多1秒 | 1秒数据 ✅ |
| 0.5秒 | 120次 | 最多0.5秒 | 0.5秒数据 |

**重要**：配额准确性由Redis原子操作保证，不依赖同步间隔！

---

## 🔧 配置示例

### 开发环境（docker-compose.yml）

```yaml
environment:
  # 配额同步配置（开发环境）
  - QUOTA_SYNC_QUEUE_SIZE=10000
  - QUOTA_LOG_QUEUE_SIZE=10000
  - QUOTA_SYNC_BATCH_SIZE=500
  - QUOTA_SYNC_INTERVAL_MS=1000  # 1秒
```

### 生产环境（.env）

```bash
# 低流量应用（< 10 QPS）
QUOTA_SYNC_QUEUE_SIZE=5000
QUOTA_LOG_QUEUE_SIZE=5000
QUOTA_SYNC_BATCH_SIZE=200
QUOTA_SYNC_INTERVAL_MS=5000  # 5秒

# 中等流量应用（10-100 QPS）- 推荐
QUOTA_SYNC_QUEUE_SIZE=10000
QUOTA_LOG_QUEUE_SIZE=10000
QUOTA_SYNC_BATCH_SIZE=500
QUOTA_SYNC_INTERVAL_MS=1000  # 1秒

# 高流量应用（> 100 QPS）
QUOTA_SYNC_QUEUE_SIZE=50000
QUOTA_LOG_QUEUE_SIZE=50000
QUOTA_SYNC_BATCH_SIZE=1000
QUOTA_SYNC_INTERVAL_MS=500  # 0.5秒
```

---

## 📊 监控指标

### 关键指标

1. **队列积压**
   ```
   同步队列长度 / 队列容量 < 80%
   ```

2. **同步延迟**
   ```
   当前时间 - 最后同步时间 < 2 × 同步间隔
   ```

3. **丢弃率**
   ```
   丢弃任务数 / 总任务数 < 0.1%
   ```

### 告警阈值

| 指标 | 正常 | 警告 | 严重 |
|------|------|------|------|
| 队列使用率 | < 60% | 60-80% | > 80% |
| 同步延迟 | < 2s | 2-5s | > 5s |
| 丢弃率 | < 0.1% | 0.1-1% | > 1% |

---

## 🎛️ 调优建议

### 场景1：队列经常满

**症状**：日志中频繁出现"队列已满"警告

**原因**：
- QPS过高
- 同步间隔过长
- 队列容量过小

**解决方案**：
```bash
# 方案1：增加队列容量
QUOTA_SYNC_QUEUE_SIZE=20000

# 方案2：缩短同步间隔
QUOTA_SYNC_INTERVAL_MS=500

# 方案3：增加批次大小（减少积压）
QUOTA_SYNC_BATCH_SIZE=1000
```

---

### 场景2：DB压力过大

**症状**：数据库CPU/IO使用率高

**原因**：
- 同步间隔过短
- 批次过小

**解决方案**：
```bash
# 方案1：延长同步间隔
QUOTA_SYNC_INTERVAL_MS=2000  # 2秒

# 方案2：增加批次大小
QUOTA_SYNC_BATCH_SIZE=1000

# 方案3：两者结合
QUOTA_SYNC_INTERVAL_MS=2000
QUOTA_SYNC_BATCH_SIZE=1000
```

---

### 场景3：DB数据延迟过大

**症状**：查询DB时配额数据不准确

**原因**：
- 同步间隔过长

**解决方案**：
```bash
# 缩短同步间隔
QUOTA_SYNC_INTERVAL_MS=500  # 0.5秒

# 注意：确保DB能承受更高的写入频率
```

---

## 🔍 故障排查

### 问题1：配额数据不同步

**检查步骤**：

1. 检查Redis中的配额
   ```bash
   docker exec flow-redis-dev redis-cli -a password GET "quota:token_xxx"
   ```

2. 检查DB中的配额
   ```sql
   SELECT remaining_quota, quota_synced_at 
   FROM access_tokens 
   WHERE access_token = 'token_xxx';
   ```

3. 检查同步队列状态
   ```bash
   # 查看日志
   docker logs flow-codeblock-go-dev | grep "同步"
   ```

**可能原因**：
- 同步队列已满
- 同步间隔过长
- DB连接失败

---

### 问题2：日志丢失

**检查步骤**：

1. 检查日志队列容量
   ```bash
   # 查看启动日志
   docker logs flow-codeblock-go-dev | grep "QuotaService"
   ```

2. 检查丢弃警告
   ```bash
   docker logs flow-codeblock-go-dev | grep "队列已满"
   ```

**解决方案**：
```bash
# 增加日志队列容量
QUOTA_LOG_QUEUE_SIZE=20000
```

---

## 📚 相关文档

- [配额系统使用文档](QUOTA_SYSTEM.md)
- [配额同步策略](QUOTA_SYNC_STRATEGY.md)
- [配额原子操作](QUOTA_ATOMIC_OPERATION.md)
- [配额清理服务](QUOTA_CLEANUP_SERVICE.md)

---

## 🎯 最佳实践

### 推荐配置（中等流量）

```bash
# 队列容量：10000（足够缓冲）
QUOTA_SYNC_QUEUE_SIZE=10000
QUOTA_LOG_QUEUE_SIZE=10000

# 批次大小：500（平衡性能）
QUOTA_SYNC_BATCH_SIZE=500

# 同步间隔：1秒（实时性好）
QUOTA_SYNC_INTERVAL_MS=1000
```

### 配置原则

1. **队列容量**：宁大勿小，避免丢弃
2. **批次大小**：根据DB性能调整
3. **同步间隔**：平衡实时性和性能
4. **监控告警**：及时发现问题

### 调优流程

1. 使用默认配置启动
2. 监控队列使用率和DB压力
3. 根据实际情况调整
4. 持续监控和优化

---

**文档版本**: v1.0  
**最后更新**: 2025-10-18  
**推荐配置**: 1秒同步间隔，500批次大小
