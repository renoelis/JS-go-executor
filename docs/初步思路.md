# Token æŸ¥è¯¢é‚®ç®±éªŒè¯ç åŠŸèƒ½å®ç°æ–¹æ¡ˆ

## ä¸€ã€éœ€æ±‚èƒŒæ™¯

ä¸ºäº†æå‡ `/flow/query-token` æ¥å£çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„ç”¨æˆ·é€šè¿‡ `ws_id + email` ç›´æ¥è·å– Token ä¿¡æ¯ï¼Œå¼•å…¥é‚®ç®±éªŒè¯ç æœºåˆ¶ã€‚

### 1.1 å®‰å…¨é—®é¢˜

**å½“å‰é£é™©**ï¼š
- ä»»ä½•çŸ¥é“ `ws_id + email` çš„äººéƒ½èƒ½æŸ¥è¯¢åˆ°å®Œæ•´çš„ Access Token
- æ”»å‡»è€…å¯ä»¥å†™è„šæœ¬æ‰¹é‡è·å–Token
- æ— æ³•éªŒè¯æŸ¥è¯¢è€…å¯¹é‚®ç®±çš„æ§åˆ¶æƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¼•å…¥é‚®ç®±éªŒè¯ç æœºåˆ¶ï¼ˆéªŒè¯é‚®ç®±æ‰€æœ‰æƒï¼‰
- ä½¿ç”¨Sessioné˜²æŠ¤ï¼ˆé˜²æ­¢è„šæœ¬æ”»å‡»ï¼‰
- é€šè¿‡è½»æµWebhookå‘é€é‚®ä»¶ï¼ˆæ— éœ€è‡ªå»ºSMTPï¼‰

### 1.2 æ–¹æ¡ˆé€‰å‹ï¼šSession vs ä¸´æ—¶Token

| å¯¹æ¯”é¡¹ | Sessionæ–¹æ¡ˆ âœ… | ä¸´æ—¶Tokenæ–¹æ¡ˆ |
|-------|--------------|-------------|
| **ç”¨æˆ·ä½“éªŒ** | â­â­â­â­â­ æ— æ„ŸçŸ¥ï¼Œè‡ªåŠ¨ç»­æœŸ | â­â­â­ å¯èƒ½éœ€è¦åˆ·æ–°é¡µé¢ |
| **å®ç°å¤æ‚åº¦** | â­â­â­ ä¸­ç­‰ï¼ˆCookieç®¡ç†ï¼‰ | â­â­â­â­ è¾ƒå¤æ‚ï¼ˆå‰ç«¯ç®¡ç†ï¼‰ |
| **å®‰å…¨æ€§** | â­â­â­â­ IP+UAç»‘å®š | â­â­â­â­â­ ä¸€æ¬¡æ€§ä½¿ç”¨ |
| **é€‚ç”¨åœºæ™¯** | é•¿æ—¶é—´æµ‹è¯•ï¼ˆ1å°æ—¶+ï¼‰ | çŸ­æ—¶é—´æ“ä½œï¼ˆ10åˆ†é’Ÿï¼‰ |

**æœ€ç»ˆé€‰æ‹©**ï¼šSessionæ–¹æ¡ˆï¼ˆç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼Œå®‰å…¨æ€§ä»ç„¶è¶³å¤Ÿï¼‰

## äºŒã€æ•´ä½“æ¶æ„

### 2.1 æ¶æ„æµç¨‹å›¾

```
ç”¨æˆ·æµè§ˆå™¨                åç«¯æœåŠ¡å™¨              è½»æµWebhook              ç”¨æˆ·é‚®ç®±
(ç”¨æˆ·IP)                 (æœåŠ¡å™¨IP)            (ä»…å…è®¸æœåŠ¡å™¨IP)
    â”‚                       â”‚                       â”‚                    â”‚
    â”‚ â‘  è®¿é—®æµ‹è¯•å·¥å…·é¡µé¢      â”‚                       â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                    â”‚
    â”‚                       â”‚ åˆ›å»ºSession            â”‚                    â”‚
    â”‚                       â”‚ (ç»‘å®šIP+UA)           â”‚                    â”‚
    â”‚ â‘¡ è¿”å›é¡µé¢+Cookie       â”‚                       â”‚                    â”‚
    â”‚ Set-Cookie: session   â”‚                       â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
    â”‚                       â”‚                       â”‚                    â”‚
    â”‚ â‘¢ è¾“å…¥ws_id+email      â”‚                       â”‚                    â”‚
    â”‚    ç‚¹å‡»"å‘é€éªŒè¯ç "      â”‚                       â”‚                    â”‚
    â”‚ Cookie: sessionè‡ªåŠ¨æºå¸¦ â”‚                       â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                    â”‚
    â”‚                       â”‚ éªŒè¯Session            â”‚                    â”‚
    â”‚                       â”‚ (IP+UA+ç­¾å+è‡ªåŠ¨ç»­æœŸ) â”‚                    â”‚
    â”‚                       â”‚ ç”Ÿæˆ6ä½éªŒè¯ç           â”‚                    â”‚
    â”‚                       â”‚ ä¿å­˜åˆ°Redis(5åˆ†é’Ÿ)    â”‚                    â”‚
    â”‚                       â”‚                       â”‚                    â”‚
    â”‚                       â”‚ â‘£ POST Webhook        â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚ {ws_id, email, code}  â”‚ éªŒè¯IPç™½åå•        â”‚
    â”‚                       â”‚                       â”‚                    â”‚
    â”‚                       â”‚                       â”‚ â‘¤ å‘é€é‚®ä»¶          â”‚
    â”‚                       â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                       â”‚ â‘¥ è¿”å›requestId       â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚ â‘¦ æç¤ºéªŒè¯ç å·²å‘é€      â”‚                       â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
    â”‚                       â”‚                       â”‚                    â”‚
    â”‚ â‘§ è¾“å…¥éªŒè¯ç             â”‚                       â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                    â”‚
    â”‚                       â”‚ éªŒè¯éªŒè¯ç              â”‚                    â”‚
    â”‚                       â”‚ è¿”å›Tokenä¿¡æ¯          â”‚                    â”‚
    â”‚ â‘¨ æ˜¾ç¤ºTokenä¿¡æ¯         â”‚                       â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
```

### 2.2 åŠŸèƒ½å¼€å…³è®¾è®¡

ç³»ç»Ÿé€šè¿‡ç¯å¢ƒå˜é‡ `TOKEN_VERIFY_ENABLED` æ§åˆ¶åŠŸèƒ½å¯ç”¨çŠ¶æ€ï¼š

- **`false` (é»˜è®¤)**ï¼šå…¼å®¹æ—§ç‰ˆï¼Œç›´æ¥é€šè¿‡ `ws_id + email` æŸ¥è¯¢ Token
- **`true`**ï¼šå¯ç”¨éªŒè¯ç éªŒè¯ï¼Œå¿…é¡»é€šè¿‡é‚®ç®±éªŒè¯æ‰èƒ½æŸ¥è¯¢ Token

## ä¸‰ã€Webhook é›†æˆæ–¹æ¡ˆ

### 3.1 Webhook é…ç½®

**URL**: `https://qingflow.com/api/qsource/f93123d7-9bab-404b-862e-cd5f8475e247`

**è¯·æ±‚æ–¹å¼**: `POST`

**è¯·æ±‚ä½“ç¤ºä¾‹**:
```json
{
    "ws_id": "test_workspace",
    "email": "user@example.com",
    "code": "123456"
}
```

**å“åº”æ ¼å¼**:
```json
{
    "errCode": 0,
    "errMsg": null,
    "result": {
        "requestId": "bc65e704-81f9-4dfb-832d-38ec4bfc4cb52025-11-05 11:32:32"
    }
}
```

### 3.2 å®‰å…¨è¯´æ˜

#### âš ï¸ ç›´æ¥ä¼ è¾“ï¼Œæ— åŠ è§£å¯†
ç”±äºè½»æµæ²¡æœ‰ä»£ç èŠ‚ç‚¹ï¼Œæ— æ³•å®ç°ç­¾åéªŒè¯ï¼Œå®‰å…¨ä¾èµ–ä»¥ä¸‹æªæ–½ï¼š

1. **IP ç™½åå•**ï¼ˆä¸»è¦é˜²æŠ¤ï¼‰
   - è½»æµä¾§é…ç½®ä»…å…è®¸æœåŠ¡å™¨ IP è®¿é—®
   - Webhook URL ä¸æš´éœ²ç»™å‰ç«¯

2. **åç«¯ä¸­è½¬**
   - å‰ç«¯åªè°ƒç”¨åç«¯æ¥å£
   - åç«¯ä»£ç† Webhook è¯·æ±‚
   - ç”¨æˆ·æ— æ³•ç›´æ¥è®¿é—® Webhook URL

3. **requestId è¿½è¸ª**
   - ä¿å­˜è½»æµè¿”å›çš„ requestId
   - ç”¨äºæ’æŸ¥é‚®ä»¶å‘é€é—®é¢˜

## å››ã€Session é˜²æŠ¤æ–¹æ¡ˆ

### 4.1 è®¾è®¡ç›®æ ‡

é˜²æ­¢æ”»å‡»è€…ç»•è¿‡å‰ç«¯ï¼Œç›´æ¥è°ƒç”¨ `/flow/token/request-verify-code` æ¥å£æ‰¹é‡å‘é€éªŒè¯ç ã€‚åŒæ—¶æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒï¼Œæ•´ä¸ªæµè§ˆä¼šè¯æœŸé—´æ— éœ€å…³å¿ƒå‡­è¯è¿‡æœŸé—®é¢˜ã€‚

### 4.2 Session æœºåˆ¶

#### Session ç‰¹æ€§

1. **å¤šé‡ç»‘å®š**
   - IP åœ°å€ï¼šSession åªèƒ½åœ¨åˆ›å»ºæ—¶çš„ IP ä½¿ç”¨
   - User-Agentï¼šé˜²æ­¢ Cookie è¢«ç›—ç”¨è·¨è®¾å¤‡ä½¿ç”¨
   - è‡ªåŠ¨ç»­æœŸï¼šæ¯æ¬¡ä½¿ç”¨è‡ªåŠ¨å»¶é•¿æœ‰æ•ˆæœŸ

2. **HMAC ç­¾å**
   - Cookie æ ¼å¼ï¼š`sessionID.signature`
   - ç­¾åå¯†é’¥ï¼šä»…æœåŠ¡ç«¯æŒæœ‰ï¼ˆç¯å¢ƒå˜é‡ï¼‰
   - æ— æ³•ä¼ªé€ æˆ–ç¯¡æ”¹

3. **é¢‘ç‡é™åˆ¶**
   - åŒä¸€ IP 5 åˆ†é’Ÿå†…æœ€å¤šåˆ›å»º 5 ä¸ª Session
   - å…è®¸ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œä½†é˜²æ­¢æ‰¹é‡åˆ›å»º

4. **æµè§ˆå™¨çº§åˆ«ç”Ÿå‘½å‘¨æœŸ**
   - Session Cookieï¼šæµè§ˆå™¨å…³é—­è‡ªåŠ¨å¤±æ•ˆ
   - æ´»è·ƒç”¨æˆ·ï¼šæ¯æ¬¡è¯·æ±‚è‡ªåŠ¨ç»­æœŸï¼ˆ1å°æ—¶ï¼‰
   - é•¿æ—¶é—´ä¸æ´»è·ƒï¼šSession è¿‡æœŸï¼ˆ1å°æ—¶ï¼‰

#### Session ç”Ÿå‘½å‘¨æœŸ

```
æ‰“å¼€é¡µé¢ â†’ åˆ›å»ºSession(1å°æ—¶TTL) â†’ æµè§ˆè¿‡ç¨‹ä¸­æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨ç»­æœŸ â†’ å…³é—­æµè§ˆå™¨å¤±æ•ˆ
```

#### ç”¨æˆ·ä½“éªŒä¼˜åŠ¿

âœ… **æ— ç¼ä½“éªŒ**ï¼šæ•´ä¸ªæµè§ˆä¼šè¯æœŸé—´æ— éœ€å…³å¿ƒå‡­è¯è¿‡æœŸ  
âœ… **è‡ªåŠ¨ç»­æœŸ**ï¼šæ´»è·ƒç”¨æˆ·å¯ä»¥æ— é™æœŸä½¿ç”¨ï¼ˆæŒç»­ç»­æœŸï¼‰  
âœ… **åˆ·æ–°é¡µé¢ä¸å—å½±å“**ï¼šSession Cookie ä¿æŒæœ‰æ•ˆ  
âœ… **å‰ç«¯é›¶æ„ŸçŸ¥**ï¼šæµè§ˆå™¨è‡ªåŠ¨æºå¸¦ Cookieï¼Œæ— éœ€å‰ç«¯ç®¡ç†  

### 4.3 éªŒè¯æµç¨‹

```go
// ä¸¥æ ¼éªŒè¯æ­¥éª¤
1. ä» Cookie è·å–ç­¾åå€¼ â†’ æ£€æŸ¥æ˜¯å¦å­˜åœ¨
2. è§£æå¹¶éªŒè¯ HMAC ç­¾å â†’ é˜²ä¼ªé€ 
3. ä» Redis è·å– Session æ•°æ® â†’ æ£€æŸ¥å­˜åœ¨æ€§
4. éªŒè¯ IP åœ°å€åŒ¹é… â†’ é˜²è½¬ç§»
5. éªŒè¯ User-Agent åŒ¹é… â†’ é˜²è·¨è®¾å¤‡
6. æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´ â†’ è‡ªåŠ¨ç»­æœŸ
7. é‡æ–°è®¾ç½® TTL â†’ å»¶é•¿æœ‰æ•ˆæœŸ
```

## äº”ã€æ•°æ®å­˜å‚¨è®¾è®¡

### 5.1 Redis å­˜å‚¨ï¼ˆæ— éœ€ä¿®æ”¹æ•°æ®åº“ï¼‰

æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨ Redis ä¸­ï¼Œ**å®Œå…¨ä¸å½±å“ç°æœ‰ MySQL æ•°æ®åº“è¡¨**ã€‚

#### å­˜å‚¨ç»“æ„

```
1. Sessionæ•°æ®
   Key: page_session:{sessionID}
   Value: JSON {session_id, ip, user_agent, created_at, last_used}
   TTL: 1å°æ—¶ï¼ˆæ¯æ¬¡ä½¿ç”¨è‡ªåŠ¨ç»­æœŸï¼‰

2. Sessionåˆ›å»ºé¢‘ç‡é™åˆ¶
   Key: page_session_rate:{ip}
   Value: åˆ›å»ºæ¬¡æ•°
   TTL: 5åˆ†é’Ÿ

3. éªŒè¯ç æ•°æ®
   Key: token_verify_code:{email}:{ws_id}
   Value: JSON {code, created_at, ip, attempts}
   TTL: 5åˆ†é’Ÿ

4. å†·å´æ—¶é—´
   Key: token_verify_cooldown:{email}:{ws_id}
   Value: "1"
   TTL: 60ç§’

5. é‚®ç®±é¢‘ç‡é™åˆ¶
   Key: token_verify_rate:{email}
   Value: è¯·æ±‚æ¬¡æ•°
   TTL: 1å°æ—¶

6. IPé¢‘ç‡é™åˆ¶
   Key: token_verify_rate:{ip}
   Value: è¯·æ±‚æ¬¡æ•°
   TTL: 1å°æ—¶
```

### 5.2 å¯é€‰ï¼šå®¡è®¡æ—¥å¿—è¡¨ï¼ˆæ–°å¢ï¼‰

å¦‚éœ€è®°å½•éªŒè¯ç å‘é€å†å²ï¼Œå¯åˆ›å»ºæ–°è¡¨ï¼ˆ**ä¸å½±å“ç°æœ‰åŠŸèƒ½**ï¼‰ï¼š

```sql
CREATE TABLE IF NOT EXISTS token_verify_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    ws_id VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    code_hash VARCHAR(64) NOT NULL COMMENT 'éªŒè¯ç å“ˆå¸Œï¼ˆä¸å­˜æ˜æ–‡ï¼‰',
    webhook_request_id VARCHAR(255) COMMENT 'è½»æµè¿”å›çš„requestId',
    ip VARCHAR(50),
    status VARCHAR(20) NOT NULL DEFAULT 'sent' COMMENT 'sent/verified/failed/expired',
    error_msg TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    verified_at TIMESTAMP NULL,
    INDEX idx_email (email),
    INDEX idx_ws_id (ws_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## å…­ã€å®‰å…¨é˜²æŠ¤æªæ–½

### 6.1 å¤šå±‚é˜²æŠ¤ä½“ç³»

| é˜²æŠ¤å±‚ | æªæ–½ | é˜²æŠ¤ç›®æ ‡ |
|-------|------|---------|
| **L1: å‰ç«¯é˜²æŠ¤** | 60ç§’å€’è®¡æ—¶ç¦ç”¨æŒ‰é’® | é˜²ç”¨æˆ·è¯¯æ“ä½œ |
| **L2: SessionéªŒè¯** | IP+UAç»‘å®š+ç­¾åCookie | é˜²è„šæœ¬ç›´æ¥è°ƒç”¨ |
| **L3: å†·å´æ—¶é—´** | åŒä¸€é‚®ç®±+ws_idï¼Œ60ç§’å†…é™1æ¬¡ | é˜²çŸ­æ—¶é—´é‡å¤ |
| **L4: é¢‘ç‡é™åˆ¶** | é‚®ç®±æ¯å°æ—¶3æ¬¡ï¼ŒIPæ¯å°æ—¶10æ¬¡ | é˜²æ‰¹é‡æ”»å‡» |
| **L5: Webhookéšè—** | URLä»…åç«¯æŒæœ‰ | é˜²URLæ³„éœ² |
| **L6: IPç™½åå•** | è½»æµä¾§é™åˆ¶æœåŠ¡å™¨IP | é˜²å¤–éƒ¨è°ƒç”¨ |

### 6.2 æ”»å‡»æˆæœ¬åˆ†æ

| æ”»å‡»æ–¹å¼ | éš¾åº¦ | é˜²æŠ¤æªæ–½ |
|---------|------|---------|
| ç›´æ¥è°ƒç”¨API | â­â­â­â­â­ | éœ€è¦æœ‰æ•ˆSession Cookieï¼ˆæ— æ³•ä¼ªé€ ï¼‰ |
| æ‰¹é‡åˆ›å»ºSession | â­â­â­â­ | 5åˆ†é’Ÿå†…æœ€å¤š5ä¸ªSession |
| Cookieè½¬ç§»ä½¿ç”¨ | â­â­â­â­â­ | IP+UAç»‘å®šï¼Œæ— æ³•è·¨è®¾å¤‡ |
| ä¼ªé€ Cookie | â­â­â­â­â­ | HMACç­¾åï¼Œå¯†é’¥ä»…æœåŠ¡ç«¯ |
| CookieåŠ«æŒ | â­â­â­â­ | HttpOnlyé˜²XSSï¼ŒIP+UAåŒé‡éªŒè¯ |
| é‚®ç®±è½°ç‚¸ | â­â­â­â­ | å¤šé‡é¢‘ç‡é™åˆ¶ |

## ä¸ƒã€ç¯å¢ƒå˜é‡é…ç½®

### 7.1 å®Œæ•´é…ç½®æ¸…å•

```bash
# ========== Token éªŒè¯ç åŠŸèƒ½å¼€å…³ ==========
TOKEN_VERIFY_ENABLED=false              # é»˜è®¤falseï¼Œéœ€è¦æ—¶æ”¹ä¸ºtrue

# ========== Webhook é…ç½®ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰==========
EMAIL_WEBHOOK_ENABLED=true
EMAIL_WEBHOOK_URL=https://qingflow.com/api/qsource/f93123d7-9bab-404b-862e-cd5f8475e247
EMAIL_WEBHOOK_TIMEOUT_SEC=10

# ========== Sessioné…ç½®ï¼ˆæ¨èæ–¹æ¡ˆï¼‰==========
PAGE_SESSION_ENABLED=true               # æ˜¯å¦å¯ç”¨SessionéªŒè¯ï¼ˆæ¨èå¯ç”¨ï¼‰
PAGE_SESSION_TTL_MIN=60                 # Sessionæœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰ï¼Œæ¯æ¬¡ä½¿ç”¨è‡ªåŠ¨ç»­æœŸ
PAGE_SESSION_SECRET=                    # ğŸ” ç­¾åå¯†é’¥ï¼ˆå¿…é¡»é…ç½®ï¼Œè‡³å°‘32ä½ï¼‰
                                        # ç”Ÿæˆæ–¹å¼: openssl rand -base64 32

# ========== éªŒè¯ç é…ç½® ==========
TOKEN_VERIFY_CODE_LENGTH=6              # éªŒè¯ç é•¿åº¦
TOKEN_VERIFY_CODE_EXPIRY_SEC=300        # éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆ5åˆ†é’Ÿï¼‰
TOKEN_VERIFY_MAX_ATTEMPTS=3             # æœ€å¤§éªŒè¯å¤±è´¥æ¬¡æ•°
TOKEN_VERIFY_COOLDOWN_SEC=60            # é‡æ–°å‘é€å†·å´æ—¶é—´ï¼ˆ1åˆ†é’Ÿï¼‰

# ========== é¢‘ç‡é™åˆ¶ ==========
TOKEN_VERIFY_RATE_LIMIT_EMAIL=3         # æ¯é‚®ç®±æ¯å°æ—¶æœ€å¤šè¯·æ±‚æ¬¡æ•°
TOKEN_VERIFY_RATE_LIMIT_IP=10           # æ¯IPæ¯å°æ—¶æœ€å¤šè¯·æ±‚æ¬¡æ•°
```

### 7.2 å¯†é’¥ç”Ÿæˆæ–¹æ³•

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨ openssl
openssl rand -base64 32

# æ–¹æ³•2ï¼šä½¿ç”¨ Python
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# æ–¹æ³•3ï¼šåœ¨çº¿ç”Ÿæˆ
# https://www.random.org/strings/
```

## å…«ã€å‰ç«¯å®ç°è¦ç‚¹

### 8.1 åŒæ¨¡å¼æ”¯æŒ

å‰ç«¯æ ¹æ®åç«¯æ¨¡æ¿å˜é‡ `VerifyCodeEnabled` è‡ªåŠ¨åˆ‡æ¢ï¼š

```html
<script>
    const verifyCodeEnabled = {{.VerifyCodeEnabled}};  // Goæ¨¡æ¿å˜é‡
    const hasSession = {{.HasSession}};                 // SessionçŠ¶æ€
    
    if (hasSession) {
        console.log('âœ… Sessionå·²å°±ç»ªï¼ˆè‡ªåŠ¨ç»­æœŸï¼‰');
    } else {
        console.warn('âš ï¸ æœªèƒ½åˆ›å»ºSessionï¼Œè¯·åˆ·æ–°é¡µé¢');
    }
    
    if (verifyCodeEnabled) {
        // æ˜¾ç¤ºéªŒè¯ç æµç¨‹ï¼šè¾“å…¥ä¿¡æ¯ â†’ å‘é€éªŒè¯ç  â†’ è¾“å…¥éªŒè¯ç  â†’ è·å–Token
    } else {
        // æ˜¾ç¤ºç›´æ¥æŸ¥è¯¢æµç¨‹ï¼šè¾“å…¥ä¿¡æ¯ â†’ ç›´æ¥è·å–Token
    }
</script>
```

### 8.2 å…³é”®äº¤äº’æµç¨‹

#### å¯ç”¨éªŒè¯ç æ¨¡å¼ï¼ˆEnabled=trueï¼‰

```
æ­¥éª¤1: ç”¨æˆ·è¾“å…¥ ws_id + email
       â†“
æ­¥éª¤2: ç‚¹å‡»"å‘é€éªŒè¯ç "æŒ‰é’®
       - å‘é€è¯·æ±‚ï¼ˆSession Cookie è‡ªåŠ¨æºå¸¦ï¼‰
       - æŒ‰é’®ç¦ç”¨ï¼Œæ˜¾ç¤º60ç§’å€’è®¡æ—¶
       â†“
æ­¥éª¤3: æ˜¾ç¤ºéªŒè¯ç è¾“å…¥æ¡†
       - 6ä½æ•°å­—è¾“å…¥æ¡†
       - "éªŒè¯å¹¶è·å–Token"æŒ‰é’®
       â†“
æ­¥éª¤4: è¾“å…¥éªŒè¯ç ï¼Œç‚¹å‡»éªŒè¯
       - éªŒè¯æˆåŠŸï¼šæ˜¾ç¤ºTokenä¿¡æ¯
       - éªŒè¯å¤±è´¥ï¼šæç¤ºé”™è¯¯ï¼ˆå‰©ä½™æ¬¡æ•°ï¼‰

æ³¨æ„ï¼šæ•´ä¸ªè¿‡ç¨‹ä¸­ Session è‡ªåŠ¨ç»­æœŸï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
```

#### å…¼å®¹æ¨¡å¼ï¼ˆEnabled=falseï¼‰

```
æ­¥éª¤1: ç”¨æˆ·è¾“å…¥ ws_id + email
       â†“
æ­¥éª¤2: ç‚¹å‡»"æŸ¥è¯¢Token"æŒ‰é’®
       - ç›´æ¥è°ƒç”¨ GET /flow/query-token
       â†“
æ­¥éª¤3: æ˜¾ç¤ºTokenä¿¡æ¯
```

### 8.3 é”™è¯¯å¤„ç†

```javascript
// Sessionè¿‡æœŸå¤„ç†ï¼ˆæå°‘å‡ºç°ï¼Œé™¤éè¶…è¿‡1å°æ—¶ä¸æ´»è·ƒï¼‰
if (response.status === 401 && result.message.includes('Session')) {
    showError('âš ï¸ é¡µé¢å·²è¿‡æœŸï¼Œå³å°†è‡ªåŠ¨åˆ·æ–°...');
    setTimeout(() => window.location.reload(), 2000);
}

// éªŒè¯ç é”™è¯¯å¤„ç†
if (result.message.includes('éªŒè¯ç é”™è¯¯')) {
    showError(result.message);  // æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°
}

// é¢‘ç‡é™åˆ¶å¤„ç†
if (result.message.includes('è¯·æ±‚è¿‡äºé¢‘ç¹')) {
    showError(result.message);  // æ˜¾ç¤ºç­‰å¾…æ—¶é—´
}

// é‡è¦ï¼šæ‰€æœ‰è¯·æ±‚éƒ½è¦è®¾ç½® credentials: 'include' ä»¥æºå¸¦Cookie
fetch(url, {
    method: 'POST',
    credentials: 'include',  // å¿…é¡»è®¾ç½®
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
});
```

## ä¹ã€éƒ¨ç½²æ­¥éª¤

### 9.1 å‡†å¤‡å·¥ä½œ

```bash
# 1. å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
redis-cli SAVE
cp .env .env.backup

# 2. ç”Ÿæˆç­¾åå¯†é’¥
openssl rand -base64 32
```

### 9.2 æ›´æ–°é…ç½®

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
vi .env

# æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š
TOKEN_VERIFY_ENABLED=false              # å…ˆä¿æŒfalseï¼Œæµ‹è¯•æ— è¯¯åæ”¹ä¸ºtrue
PAGE_SESSION_ENABLED=true
PAGE_SESSION_SECRET=<åˆšæ‰ç”Ÿæˆçš„å¯†é’¥>
EMAIL_WEBHOOK_URL=https://qingflow.com/api/qsource/f93123d7-9bab-404b-862e-cd5f8475e247
```

### 9.3 éƒ¨ç½²æ–°ä»£ç 

```bash
# æ‹‰å–ä»£ç 
git pull

# ç¼–è¯‘
go mod tidy
go build -o flow-codeblock-go cmd/main.go

# é‡å¯æœåŠ¡
docker-compose down
docker-compose up -d

# æˆ–
systemctl restart flow-codeblock
```

### 9.4 éªŒè¯éƒ¨ç½²

```bash
# 1. æ£€æŸ¥æœåŠ¡å¯åŠ¨æ—¥å¿—
docker logs -f flow-codeblock-go

# åº”è¯¥çœ‹åˆ°ï¼š
# INFO  SessionæœåŠ¡å·²å¯ç”¨  ttl=1h0m0s

# 2. è®¿é—®æµ‹è¯•å·¥å…·é¡µé¢
curl -I https://your-domain.com/flow/test-tool
# è¿”å› 200 OK
# å¹¶ä¸”å“åº”å¤´ä¸­åº”è¯¥åŒ…å« Set-Cookie: flow_page_session=...

# 3. æ£€æŸ¥é¡µé¢SessionçŠ¶æ€
# æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
# åº”è¯¥çœ‹åˆ°ï¼šâœ… Sessionå·²å°±ç»ªï¼ˆè‡ªåŠ¨ç»­æœŸï¼‰

# 4. æ£€æŸ¥Cookie
# åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Application â†’ Cookies
# åº”è¯¥çœ‹åˆ° flow_page_session Cookieï¼ˆHttpOnlyï¼‰
```

### 9.5 æ¸è¿›å¼å¯ç”¨

```bash
# é˜¶æ®µ1ï¼šä»…éƒ¨ç½²ä»£ç ï¼ŒåŠŸèƒ½ä¸å¯ç”¨ï¼ˆæµ‹è¯•å…¼å®¹æ€§ï¼‰
TOKEN_VERIFY_ENABLED=false
PAGE_SESSION_ENABLED=false

# é˜¶æ®µ2ï¼šå¯ç”¨Sessionï¼Œæµ‹è¯•é˜²æŠ¤æ•ˆæœ
TOKEN_VERIFY_ENABLED=false
PAGE_SESSION_ENABLED=true

# é˜¶æ®µ3ï¼šå®Œå…¨å¯ç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
TOKEN_VERIFY_ENABLED=true
PAGE_SESSION_ENABLED=true
```

## åã€ç›‘æ§å’Œç»´æŠ¤

### 10.1 æ—¥å¿—ç›‘æ§

å…³é”®æ—¥å¿—ç¤ºä¾‹ï¼š

```
# æ­£å¸¸æµç¨‹
INFO  åˆ›å»ºé¡µé¢Session  session_id=abc123de... ip=1.2.3.4 ttl=1h0m0s
INFO  ä½¿ç”¨ç°æœ‰Session  ip=1.2.3.4
INFO  SessionéªŒè¯é€šè¿‡å¹¶å·²ç»­æœŸ  session_id=abc123de... ip=1.2.3.4
INFO  éªŒè¯ç å‘é€æˆåŠŸ  email=u***r@example.com request_id=xxx
INFO  éªŒè¯ç éªŒè¯é€šè¿‡  email=u***r@example.com

# å¼‚å¸¸æƒ…å†µ
WARN  Sessionä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ  ip=5.6.7.8 session_id=abc123de...
WARN  Session IPä¸åŒ¹é…  session_ip=1.2.3.4 request_ip=5.6.7.8
WARN  Session User-Agentä¸åŒ¹é…  session_ua=... request_ua=...
WARN  IPåˆ›å»ºSessionè¿‡äºé¢‘ç¹  ip=1.2.3.4 count=10
WARN  éªŒè¯ç é”™è¯¯  email=u***r@example.com remaining=2
```

### 10.2 æ€§èƒ½æŒ‡æ ‡

ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

- Sessionåˆ›å»ºé€Ÿç‡ï¼ˆæ­£å¸¸ï¼š< 10/åˆ†é’Ÿï¼‰
- SessionéªŒè¯æˆåŠŸç‡ï¼ˆç›®æ ‡ï¼š> 99%ï¼‰
- Sessionè‡ªåŠ¨ç»­æœŸæ¬¡æ•°ï¼ˆæ­£å¸¸ç”¨æˆ·ï¼šé«˜é¢‘ç»­æœŸï¼‰
- éªŒè¯ç å‘é€æˆåŠŸç‡ï¼ˆç›®æ ‡ï¼š> 99%ï¼‰
- Webhookå“åº”æ—¶é—´ï¼ˆç›®æ ‡ï¼š< 2ç§’ï¼‰
- Redisè¿æ¥æ•°ï¼ˆæ­£å¸¸ï¼š< 100ï¼‰

### 10.3 æ•…éšœæ’æŸ¥

#### é—®é¢˜1ï¼šç”¨æˆ·æ”¶ä¸åˆ°éªŒè¯ç 

```bash
# æ£€æŸ¥æ­¥éª¤ï¼š
1. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼šæ˜¯å¦è°ƒç”¨WebhookæˆåŠŸ
2. æŸ¥çœ‹è½»æµåå°ï¼šæ˜¯å¦æ”¶åˆ°è¯·æ±‚ã€æ˜¯å¦å‘é€é‚®ä»¶
3. æ£€æŸ¥requestIdï¼šåœ¨è½»æµä¸­æœç´¢å¯¹åº”è®°å½•
4. æ£€æŸ¥é‚®ç®±ï¼šæ˜¯å¦è¿›å…¥åƒåœ¾ç®±
```

#### é—®é¢˜2ï¼šSessionéªŒè¯å¤±è´¥

```bash
# å¸¸è§åŸå› ï¼š
1. ç”¨æˆ·ä½¿ç”¨ä»£ç†/VPNï¼ˆIPå˜åŒ–ï¼‰
2. ç”¨æˆ·åˆ‡æ¢æµè§ˆå™¨ï¼ˆCookieä¸¢å¤±æˆ–User-Agentå˜åŒ–ï¼‰
3. Sessionè¿‡æœŸï¼ˆè¶…è¿‡1å°æ—¶æœªæ´»è·ƒï¼‰
4. ç­¾åå¯†é’¥é…ç½®é”™è¯¯
5. Cookieè¢«æ¸…é™¤

# è§£å†³æ–¹æ¡ˆï¼š
- æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢é‡æ–°åˆ›å»ºSession
- æ£€æŸ¥ PAGE_SESSION_SECRET é…ç½®
- æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦ç¦ç”¨Cookie
- æ£€æŸ¥HTTPSé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
```

## åä¸€ã€æŠ€æœ¯æ¶æ„æ€»ç»“

### 11.1 æŠ€æœ¯æ ˆ

- **åç«¯**: Go 1.21+
- **ç¼“å­˜**: Redis 7.0+
- **æ•°æ®åº“**: MySQL 8.0+ (ç°æœ‰è¡¨ä¸å˜)
- **é‚®ä»¶**: è½»æµ Webhook ä¸­è½¬
- **å‰ç«¯**: HTML + JavaScript (æ¨¡æ¿)

### 11.2 æ ¸å¿ƒç»„ä»¶

```
service/
â”œâ”€â”€ page_session_service.go     # SessionæœåŠ¡ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ email_webhook_service.go    # Webhooké‚®ä»¶æœåŠ¡ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ token_verify_service.go     # éªŒè¯ç æœåŠ¡ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ token_service.go            # TokenæŸ¥è¯¢æœåŠ¡ï¼ˆç°æœ‰ï¼‰

controller/
â”œâ”€â”€ token_controller.go         # Tokenæ§åˆ¶å™¨ï¼ˆä¿®æ”¹ï¼‰
â””â”€â”€ executor_controller.go      # æ‰§è¡Œå™¨æ§åˆ¶å™¨ï¼ˆä¿®æ”¹ï¼‰

middleware/
â””â”€â”€ auth.go                     # è®¤è¯ä¸­é—´ä»¶ï¼ˆç°æœ‰ï¼‰
```

### 11.3 API ç«¯ç‚¹

```
# æ–°å¢æ¥å£
POST /flow/token/request-verify-code  # è¯·æ±‚éªŒè¯ç 
POST /flow/token/verify-and-get       # éªŒè¯ç éªŒè¯å¹¶è·å–Token

# ç°æœ‰æ¥å£ï¼ˆä¿æŒå…¼å®¹ï¼‰
GET  /flow/query-token                # ç›´æ¥æŸ¥è¯¢Tokenï¼ˆEnabled=falseæ—¶ä½¿ç”¨ï¼‰
GET  /flow/test-tool                  # æµ‹è¯•å·¥å…·é¡µé¢ï¼ˆä¿®æ”¹ï¼šè¿”å›ä¸´æ—¶Tokenï¼‰
```

## åäºŒã€æ ¸å¿ƒä»£ç ç¤ºä¾‹

### 12.1 SessionæœåŠ¡æ ¸å¿ƒä»£ç 

```go
// service/page_session_service.go (ç®€åŒ–ç‰ˆ)

// CreateSession åˆ›å»ºSession
func (s *PageSessionService) CreateSession(ctx context.Context, ip, userAgent string) (sessionID, signedCookie string, err error) {
    // 1. é¢‘ç‡é™åˆ¶æ£€æŸ¥ï¼ˆ5åˆ†é’Ÿå†…æœ€å¤š5ä¸ªï¼‰
    rateLimitKey := fmt.Sprintf("page_session_rate:%s", ip)
    count, _ := s.redisClient.Incr(ctx, rateLimitKey).Result()
    if count == 1 {
        s.redisClient.Expire(ctx, rateLimitKey, 5*time.Minute)
    }
    if count > 5 {
        return "", "", fmt.Errorf("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•")
    }
    
    // 2. ç”ŸæˆéšæœºSession ID
    b := make([]byte, 32)
    rand.Read(b)
    sessionID = hex.EncodeToString(b)
    
    // 3. ä¿å­˜Sessionæ•°æ®åˆ°Redis
    sessionData := PageSessionData{
        SessionID: sessionID,
        IP:        ip,
        UserAgent: userAgent,
        CreatedAt: time.Now(),
        LastUsed:  time.Now(),
    }
    
    key := fmt.Sprintf("page_session:%s", sessionID)
    dataJSON, _ := json.Marshal(sessionData)
    s.redisClient.Set(ctx, key, dataJSON, s.sessionTTL)
    
    // 4. ç”ŸæˆHMACç­¾åCookie
    signedCookie = s.signSessionID(sessionID)
    
    return sessionID, signedCookie, nil
}

// ValidateSession éªŒè¯Sessionå¹¶è‡ªåŠ¨ç»­æœŸ
func (s *PageSessionService) ValidateSession(ctx context.Context, signedCookie, ip, userAgent string) (bool, error) {
    // 1. éªŒè¯ç­¾å
    sessionID, err := s.verifySignature(signedCookie)
    if err != nil {
        return false, fmt.Errorf("Sessionç­¾åæ— æ•ˆ")
    }
    
    // 2. ä»Redisè·å–Sessionæ•°æ®
    key := fmt.Sprintf("page_session:%s", sessionID)
    dataJSON, err := s.redisClient.Get(ctx, key).Result()
    if err != nil {
        return false, fmt.Errorf("Sessionå·²è¿‡æœŸ")
    }
    
    var sessionData PageSessionData
    json.Unmarshal([]byte(dataJSON), &sessionData)
    
    // 3. éªŒè¯IPå’ŒUser-Agent
    if sessionData.IP != ip {
        return false, fmt.Errorf("Sessionä»…é™åŸå§‹è®¾å¤‡ä½¿ç”¨")
    }
    if sessionData.UserAgent != userAgent {
        return false, fmt.Errorf("Sessionä»…é™åŸå§‹è®¾å¤‡ä½¿ç”¨")
    }
    
    // 4. è‡ªåŠ¨ç»­æœŸ
    sessionData.LastUsed = time.Now()
    updatedJSON, _ := json.Marshal(sessionData)
    s.redisClient.Set(ctx, key, updatedJSON, s.sessionTTL)
    
    return true, nil
}
```

### 12.2 Controllerä½¿ç”¨ç¤ºä¾‹

```go
// controller/executor_controller.go

func (c *ExecutorController) TestTool(ctx *gin.Context) {
    const sessionCookieName = "flow_page_session"
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰Session
    sessionCookie, _ := ctx.Cookie(sessionCookieName)
    
    var hasSession bool
    if sessionCookie != "" {
        ip := middleware.GetRealIP(ctx)
        userAgent := ctx.Request.UserAgent()
        valid, _ := c.pageSessionService.ValidateSession(ctx.Request.Context(), sessionCookie, ip, userAgent)
        hasSession = valid
    }
    
    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆSessionï¼Œåˆ›å»ºæ–°Session
    if !hasSession && c.pageSessionService != nil {
        ip := middleware.GetRealIP(ctx)
        userAgent := ctx.Request.UserAgent()
        
        _, signedCookie, err := c.pageSessionService.CreateSession(ctx.Request.Context(), ip, userAgent)
        if err == nil {
            // è®¾ç½®Session Cookieï¼ˆæµè§ˆå™¨å…³é—­å¤±æ•ˆï¼‰
            ctx.SetCookie(
                sessionCookieName,  // name
                signedCookie,       // value
                0,                  // maxAge: 0 = Session Cookie
                "/",                // path
                "",                 // domain
                true,               // secure (HTTPS)
                true,               // httpOnly (é˜²XSS)
            )
            hasSession = true
        }
    }
    
    // æ¸²æŸ“é¡µé¢
    ctx.HTML(200, "test-tool.html", gin.H{
        "VerifyCodeEnabled": c.config.TokenVerify.Enabled,
        "HasSession":        hasSession,
        // ... å…¶ä»–æ•°æ®
    })
}
```

### 12.3 å‰ç«¯ä½¿ç”¨ç¤ºä¾‹

```javascript
// å‰ç«¯å®Œå…¨æ— éœ€ç®¡ç†Sessionï¼Œæµè§ˆå™¨è‡ªåŠ¨å¤„ç†

async function requestVerifyCode() {
    const response = await fetch('/flow/token/request-verify-code', {
        method: 'POST',
        credentials: 'include',  // ğŸ”¥ é‡è¦ï¼šè‡ªåŠ¨æºå¸¦Cookie
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            ws_id: wsId,
            email: email
            // ğŸ”¥ ä¸éœ€è¦æ‰‹åŠ¨ä¼ é€’ä»»ä½•Sessionä¿¡æ¯
        })
    });
    
    // Sessionä¼šè‡ªåŠ¨ç»­æœŸï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
}
```

---

## åä¸‰ã€å®‰å…¨æœ€ä½³å®è·µ

### 13.1 å¿…é¡»éµå®ˆ

âœ… **PAGE_SESSION_SECRET å¿…é¡»å¼ºéšæœº**ï¼ˆè‡³å°‘32ä½ï¼‰  
âœ… **å®šæœŸè½®æ¢å¯†é’¥**ï¼ˆå»ºè®®æ¯å­£åº¦æ›´æ¢ï¼‰  
âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨HTTPS**ï¼ˆSecure Cookieï¼‰  
âœ… **å¯ç”¨HttpOnlyæ ‡å¿—**ï¼ˆé˜²XSSæ”»å‡»ï¼‰  
âœ… **Webhook URL ä¸¥æ ¼ä¿å¯†**ï¼ˆä¸æäº¤åˆ°Gitï¼‰  
âœ… **å¯ç”¨IPç™½åå•**ï¼ˆè½»æµä¾§é…ç½®ï¼‰  
âœ… **ç›‘æ§å¼‚å¸¸æ—¥å¿—**ï¼ˆé¢‘ç¹å¤±è´¥çš„IPï¼‰  

### 13.2 å»ºè®®å®æ–½

â­ å®šæœŸå®¡è®¡éªŒè¯ç å‘é€æ—¥å¿—  
â­ è®¾ç½®å‘Šè­¦ï¼šå•IPçŸ­æ—¶é—´å†…å¤§é‡å¤±è´¥  
â­ å®šæœŸæ£€æŸ¥Rediså­˜å‚¨ç©ºé—´  
â­ å®šæœŸå¤‡ä»½ç¯å¢ƒå˜é‡é…ç½®  

---

## åå››ã€Sessionæ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

### 14.1 ç”¨æˆ·ä½“éªŒæå‡

âœ… **æ— ç¼ä½¿ç”¨**
- æ‰“å¼€é¡µé¢åï¼Œæ•´ä¸ªæµè§ˆä¼šè¯æœŸé—´æ— éœ€å…³å¿ƒå‡­è¯é—®é¢˜
- è‡ªåŠ¨ç»­æœŸï¼Œæ´»è·ƒç”¨æˆ·å¯ä»¥æŒç»­ä½¿ç”¨æ•°å°æ—¶

âœ… **é›¶æ„ŸçŸ¥ç®¡ç†**
- æµè§ˆå™¨è‡ªåŠ¨ç®¡ç†Cookieï¼Œå‰ç«¯æ— éœ€ä»»ä½•ä»£ç 
- ç”¨æˆ·åˆ·æ–°é¡µé¢ã€æ‰§è¡Œå¤šæ¬¡æ“ä½œï¼Œå®Œå…¨ä¸å—å½±å“

âœ… **å‹å¥½çš„é”™è¯¯æç¤º**
- æå°‘é‡åˆ°Sessionè¿‡æœŸï¼ˆéœ€è¦1å°æ—¶ä¸æ´»è·ƒï¼‰
- å³ä½¿è¿‡æœŸï¼Œåˆ·æ–°é¡µé¢å³å¯ï¼Œä¸ä¸¢å¤±å·²è¾“å…¥çš„ä»£ç 

### 14.2 å¼€å‘æ•ˆç‡æå‡

âœ… **å‰ç«¯ä»£ç ç®€åŒ–**
- ä¸éœ€è¦ç®¡ç†Tokenå˜é‡
- ä¸éœ€è¦å®šæ—¶åˆ·æ–°é€»è¾‘
- ä¸éœ€è¦Tokenè¿‡æœŸæ£€æµ‹

âœ… **åç«¯ä»£ç ç®€æ´**
- ä½¿ç”¨æˆç†Ÿçš„Cookieæœºåˆ¶
- è‡ªåŠ¨ç»­æœŸé€»è¾‘æ¸…æ™°
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

### 14.3 å®‰å…¨æ€§ä¿éšœ

è™½ç„¶ä¸æ˜¯ä¸€æ¬¡æ€§Tokenï¼Œä½†å®‰å…¨æ€§ä»ç„¶å……åˆ†ï¼š

âœ… **IPç»‘å®š** - Sessionåªèƒ½åœ¨åˆ›å»ºæ—¶çš„IPä½¿ç”¨  
âœ… **User-Agentç»‘å®š** - é˜²æ­¢Cookieè·¨è®¾å¤‡ä½¿ç”¨  
âœ… **HMACç­¾å** - æ— æ³•ä¼ªé€ Cookie  
âœ… **HttpOnly** - é˜²æ­¢XSSçªƒå–Cookie  
âœ… **Secure** - HTTPSä¼ è¾“åŠ å¯†  
âœ… **è‡ªåŠ¨ç»­æœŸéªŒè¯** - æ¯æ¬¡ä½¿ç”¨éƒ½éªŒè¯IP+UA  

### 14.4 å®é™…ä½¿ç”¨åœºæ™¯

```text
åœºæ™¯1ï¼šç”¨æˆ·æµ‹è¯•ä»£ç ï¼ˆæ­£å¸¸ä½¿ç”¨ï¼‰
- æ‰“å¼€é¡µé¢ â†’ æŸ¥è¯¢Token â†’ æ‰§è¡Œä»£ç 30åˆ†é’Ÿ â†’ ç»§ç»­æµ‹è¯•
- ç»“æœï¼šâœ… å…¨ç¨‹æ— éšœç¢

åœºæ™¯2ï¼šç”¨æˆ·é•¿æ—¶é—´æµ‹è¯•ï¼ˆè¾¹æµ‹è¯•è¾¹è°ƒè¯•ï¼‰
- æ‰“å¼€é¡µé¢ â†’ æŸ¥è¯¢Token â†’ é—´æ­‡æ€§æ‰§è¡Œä»£ç 2å°æ—¶
- ç»“æœï¼šâœ… Sessionè‡ªåŠ¨ç»­æœŸï¼Œæ— æ„ŸçŸ¥

åœºæ™¯3ï¼šç”¨æˆ·æš‚æ—¶ç¦»å¼€ï¼ˆä¸­æ–­ï¼‰
- æ‰“å¼€é¡µé¢ â†’ æŸ¥è¯¢Token â†’ ç¦»å¼€1.5å°æ—¶ â†’ å›æ¥ç»§ç»­
- ç»“æœï¼šâš ï¸ Sessionè¿‡æœŸï¼Œåˆ·æ–°é¡µé¢å³å¯ï¼ˆä½†ä»£ç å·²ä¿å­˜åœ¨æµè§ˆå™¨ï¼‰

åœºæ™¯4ï¼šæ”»å‡»è€…å°è¯•è„šæœ¬æ”»å‡»
- å†™è„šæœ¬ç›´æ¥è°ƒç”¨API
- ç»“æœï¼šâŒ æ— æœ‰æ•ˆSession Cookieï¼Œè¯·æ±‚è¢«æ‹’ç»
```

---

## é™„å½•ï¼šå¸¸è§é—®é¢˜ FAQ

**Q1: éƒ¨ç½²ä¼šå½±å“ç°æœ‰æ•°æ®åº“å—ï¼Ÿ**  
A: ä¸ä¼šã€‚æ‰€æœ‰æ–°æ•°æ®éƒ½å­˜å‚¨åœ¨Redisä¸­ï¼Œå®Œå…¨ä¸ä¿®æ”¹MySQLè¡¨ç»“æ„ã€‚

**Q2: ç°æœ‰ç”¨æˆ·ä¼šå—å½±å“å—ï¼Ÿ**  
A: ä¸ä¼šã€‚é»˜è®¤ `TOKEN_VERIFY_ENABLED=false`ï¼Œå‘åå…¼å®¹ã€‚

**Q3: Sessionè¿‡æœŸåç”¨æˆ·æ€ä¹ˆåŠï¼Ÿ**  
A: Sessioné‡‡ç”¨è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼Œæ´»è·ƒç”¨æˆ·å¯ä»¥æ— é™æœŸä½¿ç”¨ã€‚åªæœ‰è¶…è¿‡1å°æ—¶ä¸æ´»è·ƒæ‰ä¼šè¿‡æœŸï¼Œæ­¤æ—¶åˆ·æ–°é¡µé¢å³å¯é‡æ–°åˆ›å»ºSessionã€‚æ­£å¸¸ä½¿ç”¨å‡ ä¹ä¸ä¼šé‡åˆ°è¿‡æœŸé—®é¢˜ã€‚

**Q4: éªŒè¯ç å‘é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**  
A: æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„ requestIdï¼Œåˆ°è½»æµåå°æ’æŸ¥ã€‚

**Q5: å¦‚ä½•æµ‹è¯•åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Ÿ**  
A: è®¿é—®æµ‹è¯•å·¥å…·é¡µé¢ï¼ŒF12æŸ¥çœ‹æ§åˆ¶å°åº”æ˜¾ç¤º"âœ… Sessionå·²å°±ç»ª"ï¼Œåœ¨Applicationâ†’Cookiesä¸­èƒ½çœ‹åˆ°`flow_page_session`ï¼Œç„¶åå°è¯•å‘é€éªŒè¯ç æµ‹è¯•å®Œæ•´æµç¨‹ã€‚

**Q6: ä¸ºä»€ä¹ˆé€‰æ‹©Sessionæ–¹æ¡ˆè€Œä¸æ˜¯ä¸´æ—¶Tokenï¼Ÿ**  
A: Sessionæ–¹æ¡ˆæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œæ´»è·ƒç”¨æˆ·è‡ªåŠ¨ç»­æœŸæ— éœ€å…³å¿ƒè¿‡æœŸé—®é¢˜ï¼ŒåŒæ—¶å®‰å…¨æ€§ä¸é™ä½ï¼ˆIP+UAç»‘å®š+HMACç­¾åï¼‰ã€‚

**Q7: Session Cookieå®‰å…¨å—ï¼Ÿ**  
A: æ˜¯çš„ã€‚Session Cookieè®¾ç½®äº†HttpOnlyï¼ˆé˜²XSSï¼‰ã€Secureï¼ˆHTTPSï¼‰ã€SameSiteç­‰å®‰å…¨æ ‡å¿—ï¼Œå¹¶ä¸”ç»‘å®šIPå’ŒUser-Agentï¼Œå³ä½¿Cookieæ³„éœ²ä¹Ÿæ— æ³•åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (Sessionæ–¹æ¡ˆ)  
**æœ€åæ›´æ–°**: 2025-11-05  
**æ›´æ–°å†…å®¹**: ä»ä¸´æ—¶Tokenæ–¹æ¡ˆå‡çº§ä¸ºSessionæ–¹æ¡ˆï¼Œæå‡ç”¨æˆ·ä½“éªŒ  
**ç»´æŠ¤è€…**: Flow-CodeBlock å›¢é˜Ÿ