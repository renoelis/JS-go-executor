# Flow-CodeBlock Goç‰ˆæœ¬ - ç”Ÿäº§ç¯å¢ƒ Docker Composeé…ç½®
# åŸºäº Go + goja çš„é«˜æ€§èƒ½ JavaScript ä»£ç æ‰§è¡ŒæœåŠ¡
services:
  # ====================================================================================
  # Go ä»£ç æ‰§è¡ŒæœåŠ¡
  # ====================================================================================
  flow-codeblock-go:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    image: flow-codeblock-go:latest
    container_name: flow-codeblock-go-prod
    ports:
      - "3002:3002"
    
    environment:
      # ==================== åŸºç¡€é…ç½® ====================
      - ENVIRONMENT=production
      - PORT=3002
      - GIN_MODE=release
      
      # ==================== æ•°æ®åº“é…ç½® ====================
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=flow_user
      - DB_PASSWORD=flow_password_2025
      - DB_NAME=flow_codeblock_go
      - DB_MAX_OPEN_CONNS=100
      - DB_MAX_IDLE_CONNS=20
      - DB_CONN_MAX_LIFETIME_MIN=60
      - DB_CONN_MAX_IDLE_TIME_MIN=10
      
      # ==================== Redisé…ç½® ====================
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=flow_redis_2025
      - REDIS_DB=0
      - REDIS_POOL_SIZE=100              # Redisè¿æ¥æ± å¤§å°
      - REDIS_MIN_IDLE_CONNS=10          # æœ€å°ç©ºé—²è¿æ¥æ•°
      - REDIS_DIAL_TIMEOUT_SEC=5         # è¿æ¥è¶…æ—¶(ç§’)
      - REDIS_READ_TIMEOUT_SEC=3         # è¯»å–è¶…æ—¶(ç§’)
      - REDIS_WRITE_TIMEOUT_SEC=3        # å†™å…¥è¶…æ—¶(ç§’)
      - REDIS_MAX_RETRIES=3              # æœ€å¤§é‡è¯•æ¬¡æ•°
      
      # ==================== ğŸ” è®¤è¯é…ç½® ====================
      # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼ä½¿ç”¨å¼ºéšæœºå¯†ç ï¼
      # ç”Ÿæˆæ–¹æ³•: openssl rand -base64 32  /  ADMIN_TOKEN=$(uuidgen)
      - ADMIN_TOKEN=9560D6C9-264A-45E4-B8BF-BF4957860484
      
      # ==================== Tokenç¼“å­˜é…ç½® ====================
      - TOKEN_CACHE_HOT_SIZE=300         # ğŸ”§ çƒ­ç¼“å­˜å¤§å° 500â†’300 (å†…å­˜ä¼˜åŒ–)
      - TOKEN_CACHE_HOT_TTL_MINUTES=3    # ğŸ”§ çƒ­ç¼“å­˜TTL 5â†’3åˆ†é’Ÿ (å†…å­˜ä¼˜åŒ–)
      - TOKEN_CACHE_REDIS_TTL_MINUTES=30 # ğŸ”§ Redis TTL 60â†’30åˆ†é’Ÿ (å†…å­˜ä¼˜åŒ–)
      
      # ==================== ğŸ”¥ ç¼“å­˜å†™å…¥æ± é…ç½® ====================
      # è¯´æ˜ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¼‚æ­¥ç¼“å­˜å†™å…¥ï¼Œé˜²æ­¢ goroutine æš´æ¶¨
      - CACHE_WRITE_POOL_WORKERS=15      # Workeræ•°é‡ (æ¨è:10-20)
      - CACHE_WRITE_POOL_QUEUE_SIZE=1500 # é˜Ÿåˆ—å¤§å° (æ¨è:1000-2000)
      - CACHE_WRITE_POOL_SUBMIT_TIMEOUT_MS=50 # æäº¤è¶…æ—¶(æ¯«ç§’)
      
      # ==================== Tokené™æµé…ç½® ====================
      - RATE_LIMIT_HOT_SIZE=300          # ğŸ”§ é™æµçƒ­æ•°æ® 500â†’300 (å†…å­˜ä¼˜åŒ–)
      - RATE_LIMIT_REDIS_TTL_MINUTES=60  # Redis TTL(åˆ†é’Ÿ)
      - RATE_LIMIT_BATCH_SIZE=100        # æ‰¹é‡å†™å…¥å¤§å°
      
      # ==================== ğŸš¦ IPé™æµé…ç½® ====================
      # # è®¤è¯å‰IPé™æµï¼ˆä¸¥æ ¼ï¼‰- é˜²æ­¢æš´åŠ›ç ´è§£Token
      - IP_RATE_LIMIT_PRE_AUTH=50        # æ¯ç§’è¯·æ±‚æ•° (æ¨è:50)
      - IP_RATE_LIMIT_PRE_AUTH_BURST=100 # çªå‘è¯·æ±‚æ•° (æ¨è:100)
      
      # è®¤è¯åIPé™æµï¼ˆå®½æ¾ï¼‰- é˜²æ­¢æç«¯æ»¥ç”¨
      - IP_RATE_LIMIT_POST_AUTH=200      # æ¯ç§’è¯·æ±‚æ•° (æ¨è:200)
      - IP_RATE_LIMIT_POST_AUTH_BURST=400 # çªå‘è¯·æ±‚æ•° (æ¨è:400)
      
      # å…¨å±€IPé™æµï¼ˆå…¬å¼€ç«¯ç‚¹ï¼‰
      - IP_RATE_LIMIT_GLOBAL=50          # æ¯ç§’è¯·æ±‚æ•° (æ¨è:50)
      - IP_RATE_LIMIT_GLOBAL_BURST=100   # çªå‘è¯·æ±‚æ•° (æ¨è:100)
      
      # ==================== ğŸš€ JavaScriptæ‰§è¡Œå™¨é…ç½® ====================
      # ğŸ“‹ æ¨èé…ç½®:
      #   ğŸ–¥ï¸  2H4GæœåŠ¡å™¨: POOL=50, MAX_CONCURRENT=400, TIMEOUT=120000
      #   ğŸ–¥ï¸  4H8GæœåŠ¡å™¨: POOL=100, MAX_CONCURRENT=800, TIMEOUT=180000
      #   ğŸ–¥ï¸  8H16GæœåŠ¡å™¨: POOL=200, MAX_CONCURRENT=1600, TIMEOUT=300000
      # ğŸ”¥ å½“å‰é…ç½®: 6GBå†…å­˜ï¼Œæ”¯æŒ 200 Runtime
      - RUNTIME_POOL_SIZE=200            # Runtimeæ± å¤§å° (200 ä¸ª)
      - MIN_RUNTIME_POOL_SIZE=100        # æœ€å°æ± å¤§å° (100 ä¸ª)
      - MAX_RUNTIME_POOL_SIZE=200        # æœ€å¤§æ± å¤§å° (200 ä¸ª)
      - RUNTIME_IDLE_TIMEOUT_MIN=5       # Runtimeç©ºé—²è¶…æ—¶(åˆ†é’Ÿ)
      #- MAX_CONCURRENT_EXECUTIONS=1600   # ğŸ”§ æœ€å¤§å¹¶å‘æ•° (200 Runtime æ¨è)ï¼Œä¸ä¼ ç³»ç»Ÿä¼šåŠ¨æ€è®¡ç®—
      - CODE_CACHE_SIZE=100              # ä»£ç ç¼“å­˜å¤§å°
      - ALLOW_CONSOLE=false              # ğŸ”§ ç”Ÿäº§ç¯å¢ƒç¦ç”¨console
      
      # æ‰§è¡Œé™åˆ¶
      - MAX_CODE_LENGTH=65535            # ä»£ç é•¿åº¦é™åˆ¶(å­—èŠ‚) - 64KB
      - MAX_INPUT_SIZE=1048576           # Inputå¤§å°é™åˆ¶(å­—èŠ‚) - 1MB
      - MAX_RESULT_SIZE=5242880          # ç»“æœå¤§å°é™åˆ¶(å­—èŠ‚) - 5MB
      - EXECUTION_TIMEOUT_MS=60000      # ğŸ”§ æ‰§è¡Œè¶…æ—¶(æ¯«ç§’) - 1åˆ†é’Ÿ
      
      # ==================== ğŸ”¥ å¹¶å‘æ§åˆ¶è¶…æ—¶é…ç½® ====================
      # è¯´æ˜ï¼šæ§åˆ¶ç³»ç»Ÿç¹å¿™æ—¶çš„ç­‰å¾…è¡Œä¸º
      - CONCURRENCY_WAIT_TIMEOUT_SEC=10  # å¹¶å‘æ§½ä½ç­‰å¾…è¶…æ—¶(ç§’) - é»˜è®¤ 10 ç§’
      - RUNTIME_POOL_ACQUIRE_TIMEOUT_SEC=5  # Runtime æ± è·å–è¶…æ—¶(ç§’) - é»˜è®¤ 5 ç§’
      
      # ==================== ğŸ”¥ ç†”æ–­å™¨é…ç½® ====================
      # è¯´æ˜ï¼šé˜²æ­¢é‡åº¦è¿‡è½½ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
      - CIRCUIT_BREAKER_ENABLED=true     # æ˜¯å¦å¯ç”¨ç†”æ–­å™¨
      - CIRCUIT_BREAKER_MIN_REQUESTS=100 # æœ€å°è¯·æ±‚æ•°(è§¦å‘ç†”æ–­çš„æœ€å°æ ·æœ¬)
      - CIRCUIT_BREAKER_FAILURE_RATIO=0.9 # å¤±è´¥ç‡é˜ˆå€¼ (0.9 = 90%)
      - CIRCUIT_BREAKER_TIMEOUT_SEC=10   # OpençŠ¶æ€æŒç»­æ—¶é—´(ç§’)
      - CIRCUIT_BREAKER_MAX_REQUESTS=100 # Half-OpençŠ¶æ€æœ€å¤§æ¢æµ‹è¯·æ±‚æ•°
      
      # ==================== Fetch APIé…ç½® ====================
      - FETCH_TIMEOUT_MS=30000          # Fetchè¶…æ—¶(æ¯«ç§’) - 30ç§’
      - MAX_FORMDATA_SIZE_MB=1         # FormDataæœ€å¤§å¤§å°(MB)
      - FORMDATA_STREAMING_THRESHOLD_MB=1 # æµå¼ä¸Šä¼ é˜ˆå€¼(MB)
      - ENABLE_CHUNKED_UPLOAD=1          # å¯ç”¨åˆ†å—ä¸Šä¼ 
      - MAX_BLOB_FILE_SIZE_MB=1        # Blobæ–‡ä»¶æœ€å¤§å¤§å°(MB)
      - FORMDATA_BUFFER_SIZE=524288     # FormDataç¼“å†²åŒºå¤§å°(å­—èŠ‚)ï¼Œ512KB
      - MAX_FILE_SIZE_MB=1              # æ–‡ä»¶æœ€å¤§å¤§å°(MB)
 
      # ==================== JavaScript å†…å­˜é™åˆ¶ ====================
      - ENABLE_JS_MEMORY_LIMIT=true      # ğŸ”§ å¯ç”¨ JS ä¾§å†…å­˜é™åˆ¶
      - JS_MEMORY_LIMIT_MB=0              # ğŸ”§ é™åˆ¶å¤§å°ï¼ˆ0=ä½¿ç”¨ MAX_BLOB_FILE_SIZE_MBï¼‰
            
      
      # ==================== Goè¿è¡Œæ—¶é…ç½® ====================
      - GOMAXPROCS=0                     # 0=ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
      - GOGC=100                          # ğŸ”§ GCç›®æ ‡ç™¾åˆ†æ¯” (100â†’75ï¼Œæ›´é¢‘ç¹GCï¼Œé™ä½å†…å­˜å³°å€¼)
      
      # ==================== ğŸ” è°ƒè¯•é…ç½® ====================
      # ç”Ÿäº§ç¯å¢ƒé»˜è®¤ç¦ç”¨ï¼Œéœ€è¦æ—¶å¯ä¸´æ—¶å¯ç”¨
      - ENABLE_PPROF=false               # pprof æ€§èƒ½åˆ†ææ¥å£ (ç”Ÿäº§ç¯å¢ƒå»ºè®®ç¦ç”¨)
      
      # ==================== ğŸ”§ æµ‹è¯•å·¥å…·é…ç½® ====================
      # æµ‹è¯•å·¥å…·é¡µé¢é…ç½® - è®¿é—®åœ°å€: http://your-domain:3002/flow/test-tool
      # å¯æ ¹æ®éƒ¨ç½²ç¯å¢ƒä¿®æ”¹è¿™äº›é“¾æ¥
      - TEST_TOOL_API_URL=https://api.renoelis.top                                           # APIæœåŠ¡åœ°å€
      - TEST_TOOL_HELP_URL=https://exiao.yuque.com/rlf3k1/oanb79/fa3tqkxk1h2n912q         # Flow CodeBlock å¸®åŠ©æ–‡æ¡£
      - TEST_TOOL_API_DOC_URL=https://exiao.yuque.com/rlf3k1/oanb79/ybd2nfdshmhaihc2      # Flow CodeBlock API æ¥å£æ–‡æ¡£
      - TEST_TOOL_GUIDE_URL=https://exiao.yuque.com/rlf3k1/oanb79/olsa9bvc6vm2m26c        # Flow CodeBlock åœ¨çº¿æµ‹è¯•å·¥å…·ä½¿ç”¨æŒ‡å—
      - TEST_TOOL_EXAMPLE_URL=https://exiao.yuque.com/rlf3k1/oanb79/tlty7ic7szfr2v7v     # Flow CodeBlock ä»£ç ç¤ºä¾‹
      - TEST_TOOL_AI_URL=https://wings.qingflow.com/ultron/share/agent/443790716135587842 # è½»ç¿¼AIï¼šFlow CodeBlock ä»£ç AIåŠ©æ‰‹
      - TEST_TOOL_APPLY_URL=https://qingflow.com/f/cabirpa60001                          # ç”³è¯·å¼€é€šæœåŠ¡é“¾æ¥
    
    restart: unless-stopped
    
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    # ==================== ğŸ”§ èµ„æºé™åˆ¶ ====================
    # æ ¹æ®æœåŠ¡å™¨è§„æ ¼è°ƒæ•´
    deploy:
      resources:
        limits:
          memory: 2.5G          # ğŸ”§ 3GBå†…å­˜ (é€‚åˆ4H8GæœåŠ¡å™¨)
          cpus: '1.5'         # ğŸ”§ 2æ ¸CPU
        reservations:
          memory: 1G          # ğŸ”§ ä¿ç•™1GBå†…å­˜
          cpus: '1.0'         # ğŸ”§ ä¿ç•™1æ ¸CPU
    
    # ==================== å®‰å…¨é…ç½® ====================
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    
    # ==================== å¥åº·æ£€æŸ¥ ====================
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # ==================== ç½‘ç»œé…ç½® ====================
    networks:
      - proxy_net
    
    # ==================== æ—¥å¿—é…ç½® ====================
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    
    # ==================== å·æŒ‚è½½ ====================
    volumes:
      - /etc/localtime:/etc/localtime:ro
    
    # ==================== æ ‡ç­¾ ====================
    labels:
      - "com.flow-codeblock.service=go-executor"
      - "com.flow-codeblock.version=2.1"
      - "com.flow-codeblock.description=Goç‰ˆJavaScriptä»£ç æ‰§è¡ŒæœåŠ¡"
      - "com.flow-codeblock.environment=production"

  # ====================================================================================
  # MySQLæ•°æ®åº“æœåŠ¡
  # ====================================================================================
  mysql:
    image: mysql:8.0
    container_name: flow-codeblock-mysql-prod
    environment:
      - MYSQL_ROOT_PASSWORD=root_password_2025
      - MYSQL_DATABASE=flow_codeblock_go
      - MYSQL_USER=flow_user
      - MYSQL_PASSWORD=flow_password_2025
      - MYSQL_CHARSET=utf8mb4
      - MYSQL_COLLATION=utf8mb4_unicode_ci
    restart: unless-stopped
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "flow_user", "-pflow_password_2025"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 1G          # ğŸ”§ 2GBå†…å­˜ï¼Œæ”¯æŒæ›´å¤šè¿æ¥
          cpus: '1'         # ğŸ”§ 1.5æ ¸CPU
        reservations:
          memory: 512M          # ğŸ”§ ä¿ç•™1GBå†…å­˜
          cpus: '0.5'         # ä¿ç•™0.5æ ¸CPU
    
    # ç½‘ç»œé…ç½®
    networks:
      - proxy_net
    
    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "5"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=database"
      - "com.flow-codeblock.version=8.0"
      - "com.flow-codeblock.description=MySQLæ•°æ®åº“æœåŠ¡"

  # ====================================================================================
  # Redisç¼“å­˜æœåŠ¡
  # ====================================================================================
  redis:
    image: redis:7-alpine
    container_name: flow-codeblock-redis-prod
    command: redis-server --requirepass flow_redis_2025 --maxmemory 1gb --maxmemory-policy allkeys-lru --appendonly yes
    restart: unless-stopped
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "flow_redis_2025", "ping"]
      timeout: 3s
      retries: 3
      interval: 30s
      start_period: 10s
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 512M           # 1GBå†…å­˜
          cpus: '0.5'         # 1æ ¸CPU
        reservations:
          memory: 512M        # ä¿ç•™512MBå†…å­˜
          cpus: '0.5'         # ä¿ç•™0.5æ ¸CPU
    
    # ç½‘ç»œé…ç½®
    networks:
      - proxy_net
    
    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - redis_data:/data
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=cache"
      - "com.flow-codeblock.version=7.0"
      - "com.flow-codeblock.description=Redisç¼“å­˜æœåŠ¡(ç”Ÿäº§)"

# ====================================================================================
# ç½‘ç»œé…ç½®
# ====================================================================================
networks:
  proxy_net:
    external: true
    name: api-proxy_proxy_net

# ====================================================================================
# æ•°æ®å·
# ====================================================================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
