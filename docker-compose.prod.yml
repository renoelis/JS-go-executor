# Flow-CodeBlock Goç‰ˆæœ¬ - ç”Ÿäº§ç¯å¢ƒ Docker Composeé…ç½®
# åŸºäº Go + goja çš„é«˜æ€§èƒ½ JavaScript ä»£ç æ‰§è¡ŒæœåŠ¡
version: '3.8'

services:
  # ====================================================================================
  # Go ä»£ç æ‰§è¡ŒæœåŠ¡
  # ====================================================================================
  flow-codeblock-go:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    image: flow-codeblock-go:latest
    container_name: flow-codeblock-go-prod
    ports:
      - "3002:3002"
    
    environment:
      # ==================== åŸºç¡€é…ç½® ====================
      - ENVIRONMENT=production
      - PORT=3002
      - GIN_MODE=release
      
      # ==================== æ•°æ®åº“é…ç½® ====================
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=flow_user
      - DB_PASSWORD=flow_password_2024
      - DB_NAME=flow_codeblock_go
      - DB_MAX_OPEN_CONNS=100
      - DB_MAX_IDLE_CONNS=20
      - DB_CONN_MAX_LIFETIME_MIN=60
      - DB_CONN_MAX_IDLE_TIME_MIN=10
      
      # ==================== Redisé…ç½® ====================
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=flow_redis_2024
      - REDIS_DB=0
      - REDIS_POOL_SIZE=100              # Redisè¿æ¥æ± å¤§å°
      - REDIS_MIN_IDLE_CONNS=10          # æœ€å°ç©ºé—²è¿æ¥æ•°
      - REDIS_DIAL_TIMEOUT_SEC=5         # è¿æ¥è¶…æ—¶(ç§’)
      - REDIS_READ_TIMEOUT_SEC=3         # è¯»å–è¶…æ—¶(ç§’)
      - REDIS_WRITE_TIMEOUT_SEC=3        # å†™å…¥è¶…æ—¶(ç§’)
      - REDIS_MAX_RETRIES=3              # æœ€å¤§é‡è¯•æ¬¡æ•°
      
      # ==================== ğŸ” è®¤è¯é…ç½® ====================
      # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼ä½¿ç”¨å¼ºéšæœºå¯†ç ï¼
      # ç”Ÿæˆæ–¹æ³•: openssl rand -base64 32
      - ADMIN_TOKEN=PLEASE_CHANGE_THIS_IN_PRODUCTION_USE_STRONG_RANDOM_TOKEN
      
      # ==================== Tokenç¼“å­˜é…ç½® ====================
      - TOKEN_CACHE_HOT_SIZE=300         # ğŸ”§ çƒ­ç¼“å­˜å¤§å° 500â†’300 (å†…å­˜ä¼˜åŒ–)
      - TOKEN_CACHE_HOT_TTL_MINUTES=3    # ğŸ”§ çƒ­ç¼“å­˜TTL 5â†’3åˆ†é’Ÿ (å†…å­˜ä¼˜åŒ–)
      - TOKEN_CACHE_REDIS_TTL_MINUTES=30 # ğŸ”§ Redis TTL 60â†’30åˆ†é’Ÿ (å†…å­˜ä¼˜åŒ–)
      
      # ==================== ğŸ”¥ ç¼“å­˜å†™å…¥æ± é…ç½® ====================
      # è¯´æ˜ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¼‚æ­¥ç¼“å­˜å†™å…¥ï¼Œé˜²æ­¢ goroutine æš´æ¶¨
      - CACHE_WRITE_POOL_WORKERS=15      # Workeræ•°é‡ (æ¨è: 10-20)
      - CACHE_WRITE_POOL_QUEUE_SIZE=1500 # é˜Ÿåˆ—å¤§å° (æ¨è: 1000-2000)
      - CACHE_WRITE_POOL_SUBMIT_TIMEOUT_MS=50 # æäº¤è¶…æ—¶(æ¯«ç§’)
      
      # ==================== Tokené™æµé…ç½® ====================
      - RATE_LIMIT_HOT_SIZE=300          # ğŸ”§ é™æµçƒ­æ•°æ® 500â†’300 (å†…å­˜ä¼˜åŒ–)
      - RATE_LIMIT_REDIS_TTL_MINUTES=60  # Redis TTL(åˆ†é’Ÿ)
      - RATE_LIMIT_BATCH_SIZE=100        # æ‰¹é‡å†™å…¥å¤§å°
      
      # ==================== ğŸš¦ IPé™æµé…ç½® ====================
      # è®¤è¯å‰IPé™æµï¼ˆä¸¥æ ¼ï¼‰- é˜²æ­¢æš´åŠ›ç ´è§£Token
      - IP_RATE_LIMIT_PRE_AUTH=50        # æ¯ç§’è¯·æ±‚æ•° (æ¨è: 50)
      - IP_RATE_LIMIT_PRE_AUTH_BURST=100 # çªå‘è¯·æ±‚æ•° (æ¨è: 100)
      
      # è®¤è¯åIPé™æµï¼ˆå®½æ¾ï¼‰- é˜²æ­¢æç«¯æ»¥ç”¨
      - IP_RATE_LIMIT_POST_AUTH=200      # æ¯ç§’è¯·æ±‚æ•° (æ¨è: 200)
      - IP_RATE_LIMIT_POST_AUTH_BURST=400 # çªå‘è¯·æ±‚æ•° (æ¨è: 400)
      
      # å…¨å±€IPé™æµï¼ˆå…¬å¼€ç«¯ç‚¹ï¼‰
      - IP_RATE_LIMIT_GLOBAL=50          # æ¯ç§’è¯·æ±‚æ•° (æ¨è: 50)
      - IP_RATE_LIMIT_GLOBAL_BURST=100   # çªå‘è¯·æ±‚æ•° (æ¨è: 100)
      
      # ==================== ğŸš€ JavaScriptæ‰§è¡Œå™¨é…ç½® ====================
      # ğŸ“‹ æ¨èé…ç½®:
      #   ğŸ–¥ï¸  2H4GæœåŠ¡å™¨: POOL=50, MAX_CONCURRENT=400, TIMEOUT=120000
      #   ğŸ–¥ï¸  4H8GæœåŠ¡å™¨: POOL=100, MAX_CONCURRENT=800, TIMEOUT=180000
      #   ğŸ–¥ï¸  8H16GæœåŠ¡å™¨: POOL=200, MAX_CONCURRENT=1600, TIMEOUT=300000
      - RUNTIME_POOL_SIZE=100            # Runtimeæ± å¤§å° (é»˜è®¤: 100)
      - MIN_RUNTIME_POOL_SIZE=50         # æœ€å°æ± å¤§å° (é»˜è®¤: 50)
      - MAX_RUNTIME_POOL_SIZE=200        # æœ€å¤§æ± å¤§å° (é»˜è®¤: 200)
      - RUNTIME_IDLE_TIMEOUT_MIN=5       # Runtimeç©ºé—²è¶…æ—¶(åˆ†é’Ÿ)
      - MAX_CONCURRENT_EXECUTIONS=800    # ğŸ”§ æœ€å¤§å¹¶å‘æ•° (4H8GæœåŠ¡å™¨æ¨è)
      - CODE_CACHE_SIZE=100              # ä»£ç ç¼“å­˜å¤§å°
      - ALLOW_CONSOLE=false              # ğŸ”§ ç”Ÿäº§ç¯å¢ƒç¦ç”¨console
      
      # æ‰§è¡Œé™åˆ¶
      - MAX_CODE_LENGTH=65535            # ä»£ç é•¿åº¦é™åˆ¶(å­—èŠ‚) - 64KB
      - MAX_INPUT_SIZE=2097152           # Inputå¤§å°é™åˆ¶(å­—èŠ‚) - 2MB
      - MAX_RESULT_SIZE=5242880          # ç»“æœå¤§å°é™åˆ¶(å­—èŠ‚) - 5MB
      - EXECUTION_TIMEOUT_MS=180000      # ğŸ”§ æ‰§è¡Œè¶…æ—¶(æ¯«ç§’) - 3åˆ†é’Ÿ
      
      # ==================== ğŸ”¥ ç†”æ–­å™¨é…ç½® ====================
      # è¯´æ˜ï¼šé˜²æ­¢é‡åº¦è¿‡è½½ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
      - CIRCUIT_BREAKER_ENABLED=true     # æ˜¯å¦å¯ç”¨ç†”æ–­å™¨
      - CIRCUIT_BREAKER_MIN_REQUESTS=100 # æœ€å°è¯·æ±‚æ•°(è§¦å‘ç†”æ–­çš„æœ€å°æ ·æœ¬)
      - CIRCUIT_BREAKER_FAILURE_RATIO=0.9 # å¤±è´¥ç‡é˜ˆå€¼ (0.9 = 90%)
      - CIRCUIT_BREAKER_TIMEOUT_SEC=10   # OpençŠ¶æ€æŒç»­æ—¶é—´(ç§’)
      - CIRCUIT_BREAKER_MAX_REQUESTS=100 # Half-OpençŠ¶æ€æœ€å¤§æ¢æµ‹è¯·æ±‚æ•°
      
      # ==================== Fetch APIé…ç½® ====================
      - FETCH_TIMEOUT_MS=180000          # Fetchè¶…æ—¶(æ¯«ç§’) - 3åˆ†é’Ÿ
      - MAX_FORMDATA_SIZE_MB=100         # FormDataæœ€å¤§å¤§å°(MB)
      - FORMDATA_STREAMING_THRESHOLD_MB=1 # æµå¼ä¸Šä¼ é˜ˆå€¼(MB)
      - ENABLE_CHUNKED_UPLOAD=1          # å¯ç”¨åˆ†å—ä¸Šä¼ 
      - MAX_BLOB_FILE_SIZE_MB=100        # Blobæ–‡ä»¶æœ€å¤§å¤§å°(MB)
      - FORMDATA_BUFFER_SIZE=2097152     # FormDataç¼“å†²åŒºå¤§å°(å­—èŠ‚)
      - MAX_FILE_SIZE_MB=50              # æ–‡ä»¶æœ€å¤§å¤§å°(MB)
      
      # ==================== Goè¿è¡Œæ—¶é…ç½® ====================
      - GOMAXPROCS=0                     # 0=ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
      - GOGC=100                         # GCç›®æ ‡ç™¾åˆ†æ¯”
    
    restart: unless-stopped
    
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    # ==================== ğŸ”§ èµ„æºé™åˆ¶ ====================
    # æ ¹æ®æœåŠ¡å™¨è§„æ ¼è°ƒæ•´
    deploy:
      resources:
        limits:
          memory: 3G          # ğŸ”§ 3GBå†…å­˜ (é€‚åˆ4H8GæœåŠ¡å™¨)
          cpus: '2.0'         # ğŸ”§ 2æ ¸CPU
        reservations:
          memory: 1G          # ğŸ”§ ä¿ç•™1GBå†…å­˜
          cpus: '1.0'         # ğŸ”§ ä¿ç•™1æ ¸CPU
    
    # ==================== å®‰å…¨é…ç½® ====================
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    
    # ==================== å¥åº·æ£€æŸ¥ ====================
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # ==================== ç½‘ç»œé…ç½® ====================
    networks:
      - proxy_net
    
    # ==================== æ—¥å¿—é…ç½® ====================
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    
    # ==================== å·æŒ‚è½½ ====================
    volumes:
      - /etc/localtime:/etc/localtime:ro
    
    # ==================== æ ‡ç­¾ ====================
    labels:
      - "com.flow-codeblock.service=go-executor"
      - "com.flow-codeblock.version=2.1"
      - "com.flow-codeblock.description=Goç‰ˆJavaScriptä»£ç æ‰§è¡ŒæœåŠ¡"
      - "com.flow-codeblock.environment=production"

  # ====================================================================================
  # MySQLæ•°æ®åº“æœåŠ¡
  # ====================================================================================
  mysql:
    image: mysql:8.0
    container_name: flow-codeblock-mysql-prod
    environment:
      - MYSQL_ROOT_PASSWORD=root_password_2024
      - MYSQL_DATABASE=flow_codeblock_go
      - MYSQL_USER=flow_user
      - MYSQL_PASSWORD=flow_password_2024
      - MYSQL_CHARSET=utf8mb4
      - MYSQL_COLLATION=utf8mb4_unicode_ci
    restart: unless-stopped
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "flow_user", "-pflow_password_2024"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 2G          # ğŸ”§ 2GBå†…å­˜ï¼Œæ”¯æŒæ›´å¤šè¿æ¥
          cpus: '1.5'         # ğŸ”§ 1.5æ ¸CPU
        reservations:
          memory: 1G          # ğŸ”§ ä¿ç•™1GBå†…å­˜
          cpus: '0.5'         # ä¿ç•™0.5æ ¸CPU
    
    # ç½‘ç»œé…ç½®
    networks:
      - proxy_net
    
    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "5"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=database"
      - "com.flow-codeblock.version=8.0"
      - "com.flow-codeblock.description=MySQLæ•°æ®åº“æœåŠ¡"

  # ====================================================================================
  # Redisç¼“å­˜æœåŠ¡
  # ====================================================================================
  redis:
    image: redis:7-alpine
    container_name: flow-codeblock-redis-prod
    command: redis-server --requirepass flow_redis_2024 --maxmemory 1gb --maxmemory-policy allkeys-lru --appendonly yes
    restart: unless-stopped
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "flow_redis_2024", "ping"]
      timeout: 3s
      retries: 3
      interval: 30s
      start_period: 10s
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 1G          # 1GBå†…å­˜
          cpus: '1.0'         # 1æ ¸CPU
        reservations:
          memory: 512M        # ä¿ç•™512MBå†…å­˜
          cpus: '0.5'         # ä¿ç•™0.5æ ¸CPU
    
    # ç½‘ç»œé…ç½®
    networks:
      - proxy_net
    
    # æ•°æ®æŒä¹…åŒ–
    volumes:
      - redis_data:/data
      - /etc/localtime:/etc/localtime:ro
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    
    # æ ‡ç­¾
    labels:
      - "com.flow-codeblock.service=cache"
      - "com.flow-codeblock.version=7.0"
      - "com.flow-codeblock.description=Redisç¼“å­˜æœåŠ¡(ç”Ÿäº§)"

# ====================================================================================
# ç½‘ç»œé…ç½®
# ====================================================================================
networks:
  proxy_net:
    external: true
    name: api-proxy_proxy_net

# ====================================================================================
# æ•°æ®å·
# ====================================================================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
