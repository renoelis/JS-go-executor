# String ç´¢å¼•ç¼“å­˜é”ç«äº‰åˆ†ææŠ¥å‘Š

## é—®é¢˜æè¿°

åŸé—®é¢˜ï¼šäºŒçº§ç¼“å­˜ä½¿ç”¨ sync.Mapï¼Œåœ¨ 256-4095 èŒƒå›´å†…é¦–æ¬¡è®¿é—®æ—¶éœ€è¦ Store æ“ä½œï¼Œå­˜åœ¨å†™ç«äº‰ã€‚æ‹…å¿ƒå¤šä¸ª goroutine åŒæ—¶åˆ›å»ºä¸åŒçš„ Buffer æ—¶ï¼Œå¯èƒ½åŒæ—¶è§¦å‘ç¼“å­˜å†™å…¥ï¼Œsync.Map åœ¨é«˜å†™å…¥åœºæ™¯ä¸‹æ€§èƒ½ä¸å¦‚é¢„åˆ†é…æ•°ç»„ã€‚

## æ€§èƒ½æµ‹è¯•ç»“æœ

### 1. çº¯äºŒçº§ç¼“å­˜è®¿é—®ï¼ˆ256-4095èŒƒå›´ï¼‰

| å®ç°æ–¹æ¡ˆ | å•æ ¸ | 4æ ¸ | 16æ ¸ | å¹¶å‘æ‰©å±•æ€§ |
|---------|------|-----|------|----------|
| sync.Map (å½“å‰) | 23.73 ns/op | 6.92 ns/op | 4.64 ns/op | âœ… ä¼˜ç§€ (5.1x) |
| é¢„åˆ†é…+RWMutex | 14.08 ns/op | 90.95 ns/op | 133.5 ns/op | âŒ æå·® (0.11x) |
| å®Œå…¨é¢„åˆ†é… | 0.96 ns/op | 0.25 ns/op | 0.17 ns/op | âœ… å®Œç¾ (5.6x) |

**å…³é”®å‘ç°ï¼š**
- sync.Map åœ¨å¤šæ ¸åœºæ™¯ä¸‹æ€§èƒ½éšæ ¸å¿ƒæ•°çº¿æ€§æå‡ï¼ˆ4æ ¸æå‡3.4xï¼Œ16æ ¸æå‡5.1xï¼‰
- RWMutex æ–¹æ¡ˆåœ¨å¤šæ ¸åœºæ™¯ä¸‹æ€§èƒ½**ä¸¥é‡é€€åŒ–**ï¼ˆ4æ ¸æ…¢6.5xï¼Œ16æ ¸æ…¢9.5xï¼‰
- å®Œå…¨é¢„åˆ†é…æ–¹æ¡ˆæ€§èƒ½æœ€ä½³ï¼Œä½†ä¼šå¢åŠ å¯åŠ¨å†…å­˜

### 2. çœŸå®åœºæ™¯æµ‹è¯•ï¼ˆ90%ä¸€çº§ç¼“å­˜ + 10%äºŒçº§ç¼“å­˜ï¼‰

| å®ç°æ–¹æ¡ˆ | å•æ ¸ | 4æ ¸ | 16æ ¸ |
|---------|------|-----|------|
| sync.Map (å½“å‰) | 2.97 ns/op | 0.85 ns/op | 0.53 ns/op |
| å®Œå…¨é¢„åˆ†é… | 1.42 ns/op | 0.41 ns/op | 0.24 ns/op |

**æ€§èƒ½å·®è·ï¼š**
- å•æ ¸ï¼šå®Œå…¨é¢„åˆ†é…å¿« 2.1x
- 4æ ¸ï¼šå®Œå…¨é¢„åˆ†é…å¿« 2.1x
- 16æ ¸ï¼šå®Œå…¨é¢„åˆ†é…å¿« 2.2x

### 3. å†…å­˜åˆ†é…

- sync.Map: 0 B/op, 0 allocs/op
- å®Œå…¨é¢„åˆ†é…: 0 B/op, 0 allocs/op

ä¸¤ç§æ–¹æ¡ˆå†…å­˜åˆ†é…ç›¸åŒï¼ˆè¿è¡Œæ—¶é›¶åˆ†é…ï¼‰

## æ·±å…¥åˆ†æ

### sync.Map æ€§èƒ½ä¼˜åŠ¿çš„åŸå› 

1. **è¯»å¤šå†™å°‘ä¼˜åŒ–**ï¼šsync.Map é’ˆå¯¹è¯»å¤šå†™å°‘åœºæ™¯é«˜åº¦ä¼˜åŒ–
   - é¦–æ¬¡å†™å…¥åï¼Œåç»­å…¨éƒ¨æ˜¯è¯»å–æ“ä½œ
   - è¯»å–è·¯å¾„ä½¿ç”¨ atomic æ“ä½œï¼Œæ— é”ç«äº‰

2. **å†™å…¥åˆ†æ•£**ï¼š
   - 256-4095 å…± 3840 ä¸ªæ§½ä½
   - å¤šä¸ª goroutine å¤§æ¦‚ç‡å†™å…¥ä¸åŒçš„æ§½ä½
   - sync.Map å†…éƒ¨åˆ†æ®µé”è¿›ä¸€æ­¥é™ä½å†²çª

3. **æ— å…¨å±€é”**ï¼š
   - RWMutex å³ä½¿æ˜¯è¯»é”ä¹Ÿéœ€è¦åŸå­æ“ä½œ+å¯èƒ½çš„é˜»å¡
   - sync.Map è¯»å–è·¯å¾„å®Œå…¨æ— é”ï¼ˆfast pathï¼‰

### RWMutex æ€§èƒ½å´©æºƒçš„åŸå› 

1. **è¯»é”ç«äº‰**ï¼šæ¯æ¬¡è¯»å–éƒ½éœ€è¦è·å–è¯»é”
2. **ç¼“å­˜è¡Œä¼ªå…±äº«**ï¼šRWMutex çš„è®¡æ•°å™¨åœ¨å¤šæ ¸é—´é¢‘ç¹å¤±æ•ˆ
3. **sync.Once æ•°ç»„å¼€é”€**ï¼š3840 ä¸ª sync.Once å ç”¨å¤§é‡å†…å­˜ä¸”è®¿é—®æ•ˆç‡ä½

## ç»“è®º

### âœ… é—®é¢˜ä¸çœŸå®å­˜åœ¨

**åŸæ‹…å¿§çš„"é”ç«äº‰é—®é¢˜"åœ¨å®é™…æµ‹è¯•ä¸­å¹¶ä¸å­˜åœ¨ï¼š**

1. **sync.Map è¡¨ç°ä¼˜ç§€**ï¼šåœ¨ 16 æ ¸åœºæ™¯ä¸‹æ¯”å•æ ¸å¿« 5.1x
2. **æ›¿ä»£æ–¹æ¡ˆæ›´ç³Ÿ**ï¼šRWMutex æ–¹æ¡ˆåœ¨å¤šæ ¸ä¸‹æ€§èƒ½å´©æºƒ
3. **çœŸå®åœºæ™¯å½±å“å°**ï¼š90%è®¿é—®å‘½ä¸­ä¸€çº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜å½±å“æœ‰é™

### ğŸ“Š æ€§èƒ½å¯¹æ¯”æ€»ç»“

| åœºæ™¯ | sync.Map æ€§èƒ½ | æ˜¯å¦æœ‰é—®é¢˜ |
|-----|--------------|----------|
| å•æ ¸çº¯äºŒçº§ç¼“å­˜ | 23.73 ns/op | âœ… æ­£å¸¸ |
| 16æ ¸çº¯äºŒçº§ç¼“å­˜ | 4.64 ns/op | âœ… ä¼˜ç§€ |
| çœŸå®æ··åˆåœºæ™¯ | 0.53 ns/op | âœ… å®Œç¾ |

## ä¼˜åŒ–å»ºè®®

### å½“å‰å®ç°ï¼šä¿æŒä¸å˜ âœ… æ¨è

**ç†ç”±ï¼š**
- æ€§èƒ½å·²ç»éå¸¸å¥½ï¼ˆ16æ ¸ä¸‹ 4.64 ns/opï¼‰
- å¯åŠ¨å†…å­˜æœ€ä¼˜ï¼ˆ10KB vs 100KBï¼‰
- çœŸå®åœºæ™¯æ€§èƒ½å……è¶³ï¼ˆ0.53 ns/opï¼‰
- ä»£ç ç®€æ´å¯ç»´æŠ¤

### å¯é€‰ä¼˜åŒ–ï¼šå®Œå…¨é¢„åˆ†é… ğŸ¤” å¯é€‰

**é€‚ç”¨åœºæ™¯ï¼š**
- å¯¹æ€§èƒ½æåº¦æ•æ„Ÿï¼ˆéœ€è¦æ¦¨å–æœ€å 2x æ€§èƒ½ï¼‰
- ä¸åœ¨æ„é¢å¤– 90KB å¯åŠ¨å†…å­˜
- é«˜é¢‘åˆ›å»ºå¤§ç´¢å¼• Bufferï¼ˆ>256ï¼‰

**å®ç°æ–¹å¼ï¼š**

```go
// å®Œå…¨é¢„åˆ†é… 0-4095
var fullCache [4096]string
var fullCacheOnce sync.Once

func initFullCache() {
    for i := 0; i < 4096; i++ {
        fullCache[i] = strconv.FormatInt(int64(i), 10)
    }
}

func getIndexString(index int64) string {
    if index >= 0 && index < 4096 {
        fullCacheOnce.Do(initFullCache)
        return fullCache[index]
    }
    return strconv.FormatInt(index, 10)
}
```

**æ”¶ç›Šè¯„ä¼°ï¼š**
- æ€§èƒ½æå‡ï¼š~2xï¼ˆçœŸå®åœºæ™¯ï¼‰
- å†…å­˜å¢åŠ ï¼š+90KB å¯åŠ¨å†…å­˜
- é€‚ç”¨åœºæ™¯ï¼šå®¹å™¨åŒ–éƒ¨ç½²å®ä¾‹æ•° < 20

### ä¸æ¨èï¼šRWMutex æ–¹æ¡ˆ âŒ

- æ€§èƒ½åœ¨å¤šæ ¸ä¸‹ä¸¥é‡é€€åŒ–
- æ— ä»»ä½•ä¼˜åŠ¿

## æœ€ç»ˆå»ºè®®

**ä¿æŒå½“å‰ sync.Map å®ç°ï¼Œä¸éœ€è¦ä¼˜åŒ–ã€‚**

ç†ç”±ï¼š
1. æ€§èƒ½å·²ç»éå¸¸å¥½ï¼ˆè¿œè¶…å®é™…éœ€æ±‚ï¼‰
2. å†…å­˜å ç”¨æœ€ä¼˜
3. æ²¡æœ‰é”ç«äº‰é—®é¢˜
4. çœŸå®åœºæ™¯ 90% è®¿é—®ä¸ç»è¿‡äºŒçº§ç¼“å­˜
5. ä¼˜åŒ–æ”¶ç›Šæå°ï¼ˆ2xï¼‰vs å†…å­˜ä»£ä»·å¤§ï¼ˆ9xï¼‰

å¦‚æœæœªæ¥ç¡®å®é‡åˆ°æ€§èƒ½ç“¶é¢ˆï¼Œå¯é€šè¿‡å‹æµ‹éªŒè¯åå†è€ƒè™‘å®Œå…¨é¢„åˆ†é…æ–¹æ¡ˆã€‚
