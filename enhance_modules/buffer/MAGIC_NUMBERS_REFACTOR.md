# Buffer æ¨¡å—é­”æ³•æ•°å­—é‡æ„æŠ¥å‘Š

## ğŸ“‹ å®¡æŸ¥æ¦‚è¿°

æœ¬æŠ¥å‘Šå¯¹ `enhance_modules/buffer/` ç›®å½•ä¸‹çš„æ‰€æœ‰ Go æ–‡ä»¶è¿›è¡Œäº†å…¨é¢å®¡æŸ¥ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰ç¡¬ç¼–ç çš„é­”æ³•æ•°å­—ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„å¸¸é‡å®šä¹‰æ–¹æ¡ˆã€‚

## ğŸ¯ å·²åˆ›å»ºçš„å¸¸é‡æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**: `enhance_modules/buffer/constants.go`

è¯¥æ–‡ä»¶åŒ…å«ä»¥ä¸‹å‡ ç±»å¸¸é‡ï¼š

### 1. å†…å­˜åˆ†é…ç›¸å…³å¸¸é‡
- `DefaultPoolSize = 8192` - Buffer æ± é»˜è®¤å¤§å°ï¼ˆ8KBï¼‰
- `PoolThresholdRatio = 2` - æ± åˆ†é…é˜ˆå€¼æ¯”ä¾‹
- `MmapThreshold = 10 * 1024 * 1024` - mmap åˆ†é…é˜ˆå€¼ï¼ˆ10MBï¼‰
- `MaxActualSize = 2 * 1024 * 1024 * 1024` - æœ€å¤§å†…å­˜åˆ†é…é™åˆ¶ï¼ˆ2GBï¼‰
- `MaxSafeInteger = 9007199254740991` - JavaScript Number.MAX_SAFE_INTEGER
- `MaxStringLength = 536870888` - æœ€å¤§å­—ç¬¦ä¸²é•¿åº¦

### 2. æ€§èƒ½ä¼˜åŒ–ç›¸å…³å¸¸é‡
- `SmallBufferThreshold = 4096` - å° Buffer ä¼˜åŒ–é˜ˆå€¼ï¼ˆ4KBï¼‰
- `HexEncodeBatchSize = 8` - hex ç¼–ç æ‰¹é‡å¤„ç†å¤§å°

### 3. ç¼–ç æ± ç›¸å…³å¸¸é‡
- `EncodingPoolLevel1` åˆ° `EncodingPoolLevel10` - 10 çº§ç¼–ç æ± å®¹é‡é…ç½®
- `EncodingPoolLevelCount = 10` - ç¼–ç æ± çº§åˆ«æ•°é‡

### 4. å­—èŠ‚æ©ç å’Œæ•°å€¼èŒƒå›´å¸¸é‡
- `ByteMask = 0xFF`
- `Int8Min`, `Int8Max`, `Uint8Max`
- `Int16Min`, `Int16Max`, `Uint16Max`
- `Int32Min`, `Int32Max`, `Uint32Max`

### 5. Mmap èµ„æºç®¡ç†å¸¸é‡
- `MmapCleanupInterval = 30` - æ¸…ç†é—´éš”ï¼ˆ30ç§’ï¼‰
- `MmapLeakTimeout = 5 * 60` - æ³„æ¼è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
- `MmapCleanupBatchSize = 64` - æ¸…ç†æ‰¹é‡å¤§å°

### 6. å­—ç¬¦ç¼–ç ç›¸å…³å¸¸é‡
- `UTF8MaxBytes = 4`
- `UTF16CodeUnitSize = 2`
- `HexInvalidByte = 255`

### 7. Base64 ç›¸å…³å¸¸é‡
- `Base64PaddingChar = '='`
- `Base64BlockSize = 4`
- `Base64InputBlockSize = 3`

### 8. ç¼–ç åç§°å¸¸é‡
- `EncodingUTF8`, `EncodingHex`, `EncodingBase64` ç­‰

## ğŸ“ éœ€è¦é‡æ„çš„æ–‡ä»¶æ¸…å•

### é«˜ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½æ–‡ä»¶ï¼‰

#### 1. buffer_pool.go
**ä½ç½®**: ç¬¬ 76, 92, 95 è¡Œ
```go
// ä¿®æ”¹å‰
poolSize = 8192
if size > bp.poolSize/2
if size > 10*1024*1024

// ä¿®æ”¹å
poolSize = DefaultPoolSize
if size > bp.poolSize/PoolThresholdRatio
if size > MmapThreshold
```

#### 2. fast_alloc.go
**ä½ç½®**: ç¬¬ 24, 30, 334, 500, 511 è¡Œ
```go
// ä¿®æ”¹å‰
const maxSafeInteger = 9007199254740991
const maxActualSize = 2 * 1024 * 1024 * 1024
const maxSize = 2 * 1024 * 1024 * 1024
const maxStringLength = 536870888

// ä¿®æ”¹å
ä½¿ç”¨ MaxSafeInteger, MaxActualSize, MaxStringLength å¸¸é‡
```

#### 3. toString_optimized.go
**ä½ç½®**: ç¬¬ 26-55, 299 è¡Œ
```go
// ä¿®æ”¹å‰
{8 * 1024, sync.Pool{...}}
{16 * 1024, sync.Pool{...}}
// ... 10 ä¸ªçº§åˆ«
if dataLen < 4096

// ä¿®æ”¹å
{EncodingPoolLevel1, sync.Pool{...}}
{EncodingPoolLevel2, sync.Pool{...}}
// ... ä½¿ç”¨å¯¹åº”å¸¸é‡
if dataLen < SmallBufferThreshold
```

#### 4. base64_web.go
**ä½ç½®**: ç¬¬ 13 è¡Œ
```go
// ä¿®æ”¹å‰
const base64Chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"

// å»ºè®®
// è¿™ä¸ªå¯ä»¥ä¿ç•™ï¼Œå› ä¸ºæ˜¯ Base64 æ ‡å‡†å­—ç¬¦é›†å®šä¹‰
// æˆ–è€…ç§»åˆ° constants.go ä½œä¸º Base64Charset å¸¸é‡
```

#### 5. bigint_methods.go
**ä½ç½®**: ç¬¬ 300-302, 516-517, 587-588, 652, 714 è¡Œ
```go
// ä¿®æ”¹å‰
if val&0x8000000000000000 != 0
maxUint64 := new(big.Int).Lsh(big.NewInt(1), 64)
minInt64 := new(big.Int).Lsh(big.NewInt(-1), 63)

// å»ºè®®
// è¿™äº›æ˜¯ BigInt ä½æ“ä½œï¼Œå¯ä»¥å®šä¹‰ä¸ºå¸¸é‡æˆ–ä¿ç•™
// å› ä¸ºå®ƒä»¬è¡¨è¾¾çš„æ˜¯ç®—æ³•é€»è¾‘è€Œéé…ç½®å€¼
```

#### 6. mmap_resource.go
**ä½ç½®**: ç¬¬ 98-99, 160 è¡Œ
```go
// ä¿®æ”¹å‰
cleanupInterval: 30 * time.Second
leakTimeout: 5 * time.Minute
toRemove := make([]*MmapResource, 0, 64)

// ä¿®æ”¹å
cleanupInterval: MmapCleanupInterval * time.Second
leakTimeout: time.Duration(MmapLeakTimeout) * time.Second
toRemove := make([]*MmapResource, 0, MmapCleanupBatchSize)
```

#### 7. encoding.go
**ä½ç½®**: ç¬¬ 36-38, 86-88, 165, 230 è¡Œ
```go
// ä¿®æ”¹å‰
if len(cleaned) <= 1
for i > 0 && i > maxBytes-4

// å»ºè®®
// è¿™äº›æ˜¯ç®—æ³•é€»è¾‘å¸¸é‡ï¼Œå¯ä»¥å®šä¹‰ä¸ºï¼š
// const Base64MinLength = 2
// const UTF8MaxBytes = 4
```

### ä¸­ä¼˜å…ˆçº§ï¼ˆå·¥å…·å’Œè¾…åŠ©æ–‡ä»¶ï¼‰

#### 8. utils.go
**ä½ç½®**: ç¬¬ 24-25, 33-34, 122 è¡Œ
```go
// ä¿®æ”¹å‰
if math.IsNaN(f) || math.IsInf(f, 0) { return 0 }
mod := i % 256
return uint8(val.ToInteger() & 0xFF)

// ä¿®æ”¹å
ä½¿ç”¨ Uint8Max å’Œ ByteMask å¸¸é‡
```

#### 9. numeric_methods.go
**ä½ç½®**: ç¬¬ 45, 87, 113, 154 è¡Œ
```go
// ä¿®æ”¹å‰
result := int8(byteVal & 0xFF)
value&0xFF
byteVal & 0xFF

// ä¿®æ”¹å
ä½¿ç”¨ ByteMask å¸¸é‡
```

#### 10. write_methods.go
**ä½ç½®**: ç¬¬ 256 è¡ŒåŠå…¶ä»–ç±»ä¼¼ä½ç½®
```go
// ä¿®æ”¹å‰
if len(cleaned) <= 1

// å»ºè®®
// è¿™äº›æ˜¯ç®—æ³•é€»è¾‘ï¼Œå¯ä»¥ä¿ç•™æˆ–å®šä¹‰ä¸ºå±€éƒ¨å¸¸é‡
```

### ä½ä¼˜å…ˆçº§ï¼ˆæµ‹è¯•æ–‡ä»¶ï¼‰

æµ‹è¯•æ–‡ä»¶ä¸­çš„é­”æ³•æ•°å­—ï¼ˆå¦‚ 1000, 10000 ç­‰ï¼‰é€šå¸¸è¡¨ç¤ºæµ‹è¯•è¿­ä»£æ¬¡æ•°æˆ–æµ‹è¯•æ•°æ®å¤§å°ï¼Œå¯ä»¥ï¼š
- å®šä¹‰ä¸ºæµ‹è¯•å¸¸é‡ï¼ˆå¦‚ `BenchmarkIterations`ï¼‰
- æˆ–ä¿ç•™åœ¨æµ‹è¯•ä»£ç ä¸­ï¼ˆå› ä¸ºå®ƒä»¬æ˜¯æµ‹è¯•ç‰¹å®šçš„ï¼‰

## ğŸ”§ é‡æ„æ­¥éª¤å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒæ–‡ä»¶é‡æ„
1. ä¿®æ”¹ `buffer_pool.go` - ä½¿ç”¨å†…å­˜åˆ†é…ç›¸å…³å¸¸é‡
2. ä¿®æ”¹ `fast_alloc.go` - ä½¿ç”¨å¤§å°é™åˆ¶ç›¸å…³å¸¸é‡
3. ä¿®æ”¹ `toString_optimized.go` - ä½¿ç”¨ç¼–ç æ± ç›¸å…³å¸¸é‡
4. ä¿®æ”¹ `mmap_resource.go` - ä½¿ç”¨ mmap ç®¡ç†ç›¸å…³å¸¸é‡

### ç¬¬äºŒé˜¶æ®µï¼šå·¥å…·æ–‡ä»¶é‡æ„
5. ä¿®æ”¹ `utils.go` - ä½¿ç”¨å­—èŠ‚æ©ç å¸¸é‡
6. ä¿®æ”¹ `numeric_methods.go` - ä½¿ç”¨æ•°å€¼èŒƒå›´å¸¸é‡
7. ä¿®æ”¹ `encoding.go` - ä½¿ç”¨ç¼–ç ç›¸å…³å¸¸é‡

### ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•å’ŒéªŒè¯
8. è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
9. è¿è¡Œæ€§èƒ½æµ‹è¯•ç¡®ä¿æ€§èƒ½æ— é€€åŒ–
10. ä»£ç å®¡æŸ¥ç¡®ä¿å¸¸é‡ä½¿ç”¨æ­£ç¡®

## ğŸ“Š é‡æ„æ”¶ç›Š

### å¯ç»´æŠ¤æ€§æå‡
- âœ… æ‰€æœ‰é…ç½®å€¼é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹æ›´æ–¹ä¾¿
- âœ… å¸¸é‡å‘½åæ¸…æ™°ï¼Œä»£ç å¯è¯»æ€§æé«˜
- âœ… é¿å…é‡å¤å®šä¹‰ï¼Œå‡å°‘ä¸ä¸€è‡´é£é™©

### ä»£ç è´¨é‡æå‡
- âœ… æ¶ˆé™¤é­”æ³•æ•°å­—ï¼Œç¬¦åˆç¼–ç è§„èŒƒ
- âœ… ä¾¿äºä»£ç å®¡æŸ¥å’Œç†è§£
- âœ… é™ä½ç»´æŠ¤æˆæœ¬

### æ€§èƒ½å½±å“
- âœ… æ— æ€§èƒ½å½±å“ï¼ˆå¸¸é‡åœ¨ç¼–è¯‘æ—¶å†…è”ï¼‰
- âœ… å¯èƒ½ç•¥å¾®æå‡ç¼–è¯‘é€Ÿåº¦ï¼ˆå‡å°‘é‡å¤å­—é¢é‡ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### ä¸å»ºè®®æå–ä¸ºå¸¸é‡çš„æƒ…å†µ
1. **ç®—æ³•é€»è¾‘ä¸­çš„æ•°å€¼** - å¦‚ä½ç§»æ“ä½œä¸­çš„ `<< 8`ã€`& 0xFF` ç­‰
2. **æ•°å­¦å…¬å¼ä¸­çš„ç³»æ•°** - å¦‚ `(len + 2) / 3 * 4`ï¼ˆBase64 é•¿åº¦è®¡ç®—ï¼‰
3. **åè®®è§„èŒƒä¸­çš„å›ºå®šå€¼** - å¦‚ UTF-8 çš„ `0x80`ã€`0xC0` ç­‰å­—èŠ‚æ ‡è®°
4. **æµ‹è¯•ç‰¹å®šçš„æ•°å€¼** - å¦‚æµ‹è¯•ç”¨ä¾‹ä¸­çš„å…·ä½“æ•°æ®

### ä¿ç•™åŸæœ‰é­”æ³•æ•°å­—çš„æƒ…å†µ
æŸäº›é­”æ³•æ•°å­—å…·æœ‰æ˜ç¡®çš„è¯­ä¹‰ï¼Œæå–ä¸ºå¸¸é‡åè€Œé™ä½å¯è¯»æ€§ï¼š
- `256` åœ¨æ¨¡è¿ç®—ä¸­è¡¨ç¤ºå­—èŠ‚èŒƒå›´
- `0xFF` ä½œä¸ºå­—èŠ‚æ©ç 
- `4` åœ¨ Base64 ä¸­è¡¨ç¤ºå—å¤§å°

è¿™äº›å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡å†³å®šæ˜¯å¦æå–ã€‚

## ğŸ¯ å®æ–½å»ºè®®

### æ¸è¿›å¼é‡æ„
å»ºè®®é‡‡ç”¨æ¸è¿›å¼é‡æ„ç­–ç•¥ï¼š
1. å…ˆé‡æ„é«˜ä¼˜å…ˆçº§çš„æ ¸å¿ƒæ–‡ä»¶
2. æ¯æ¬¡é‡æ„åè¿è¡Œå®Œæ•´æµ‹è¯•
3. ç¡®è®¤æ— é—®é¢˜åå†ç»§ç»­ä¸‹ä¸€ä¸ªæ–‡ä»¶
4. ä¿æŒä»£ç åº“å§‹ç»ˆå¤„äºå¯å·¥ä½œçŠ¶æ€

### ä»£ç å®¡æŸ¥è¦ç‚¹
- ç¡®ä¿å¸¸é‡åç§°å‡†ç¡®åæ˜ å…¶ç”¨é€”
- éªŒè¯å¸¸é‡å€¼çš„æ­£ç¡®æ€§
- æ£€æŸ¥æ˜¯å¦æœ‰é—æ¼çš„é­”æ³•æ•°å­—
- ç¡®è®¤é‡æ„åçš„ä»£ç é€»è¾‘ä¸å˜

## ğŸ“š å‚è€ƒèµ„æ–™

- Node.js Buffer æ–‡æ¡£: https://nodejs.org/api/buffer.html
- Go ç¼–ç è§„èŒƒ: https://golang.org/doc/effective_go
- ä»£ç é‡æ„æœ€ä½³å®è·µ: https://refactoring.guru/

---

**ç”Ÿæˆæ—¶é—´**: 2024
**å®¡æŸ¥èŒƒå›´**: `enhance_modules/buffer/*.go`
**å¸¸é‡æ–‡ä»¶**: `enhance_modules/buffer/constants.go`
